<div class="min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center p-4">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#6366f1',
                        'secondary': '#8b5cf6',
                        'dark-bg': '#111827',
                        'dark-sidebar': '#1f2937',
                        'dark-panel': '#374151',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for chat box and side panels */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background-color: #1f2937;
        }

        /* Specific styles for the three-panel layout */
        .chat-container {
            display: flex;
            width: 100%;
            height: 90vh;
            max-width: 1200px;
        }

        /* Hide the emoji picker by default */
        #emoji-picker {
            transition: opacity 0.2s, transform 0.2s;
        }
    </style>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ENVIRONMENT/HARDCODED CONFIGURATION ---
        const hardcodedFirebaseConfig = {
            apiKey: "AIzaSyCDu1T73_HOaxC5gtHTNHev8HIfPSwbsqc",
            authDomain: "knokbak-message-panel.firebaseapp.com",
            projectId: "knokbak-message-panel",
            storageBucket: "knokbak-message-panel.firebasestorage.app",
            messagingSenderId: "424259711684",
            appId: "1:424259711684:web:6818525d64024815604f91"
        };
        
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let firebaseConfig;
        try {
            const envConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            const parsedConfig = JSON.parse(envConfig);
            firebaseConfig = (parsedConfig && parsedConfig.apiKey) ? parsedConfig : hardcodedFirebaseConfig;
        } catch (e) {
            console.warn("Could not parse environment Firebase config. Using hardcoded config.");
            firebaseConfig = hardcodedFirebaseConfig;
        }

        // --- GLOBAL APP STATE ---
        let app, db, auth;
        let currentUserId = null;
        let currentUserData = null;
        let isAuthReady = false;
        let isAdmin = false;

        // Chat State
        let currentMode = 'channels'; // 'channels' or 'dms'
        let activeChannelId = 'global'; // Current public channel ID
        let activeDmPartnerId = null; // User ID of the person currently being DMed
        let unsubscribeMessages = null;
        let unsubscribeUsers = null;

        // Public Channels Definition
        const PUBLIC_CHANNELS = [
            { id: 'global', name: 'Global Chat', icon: 'üåç' },
            { id: 'help-desk', name: 'Help Desk', icon: '‚ùì' },
            { id: 'study-group', name: 'Study Corner', icon: 'üìö' }
        ];

        // --- FIREBASE COLLECTION PATHS ---
        // Note: Access codes are used as the User ID (UID)
        const USERS_COLLECTION = `/artifacts/${appId}/public/data/users`;
        const PUBLIC_MESSAGES_COLLECTION = `/artifacts/${appId}/public/data/messages`;
        const DMS_COLLECTION = `/artifacts/${appId}/public/data/dms`; 

        // --- UTILITY FUNCTIONS ---

        function updateLoadingStatus(message) {
            const statusElement = document.getElementById('loading-status');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }
        
        function showMessageBox(title, message, duration = 3000, bgColor = 'bg-gray-700') {
            const container = document.getElementById('message-box-container');
            const messageBox = document.createElement('div');
            
            messageBox.className = `p-4 rounded-xl shadow-xl text-white transition-opacity duration-300 ${bgColor} max-w-xs`;
            messageBox.innerHTML = `<div class="font-bold">${title}</div><div class="text-sm">${message}</div>`;
            container.appendChild(messageBox);

            setTimeout(() => {
                messageBox.classList.add('opacity-0');
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, duration);
        }

        function escapeHTML(str) {
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
        }
        
        function getDmConversationId(userId1, userId2) {
            return [userId1, userId2].sort().join('_');
        }

        // --- INITIALIZATION AND AUTHENTICATION ---

        async function initFirebase() {
            try {
                setLogLevel('error'); 
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // If there's a pre-provided token from the environment, use it.
                if (initialAuthToken) {
                    updateLoadingStatus("Using environment token for sign-in...");
                    await signInWithCustomToken(auth, initialAuthToken);
                }

                // Listen for any auth state change (token sign-in or custom sign-in)
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        currentUserId = user.uid;
                        // Hide login, show loading, then proceed to app setup
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('loading-overlay').classList.remove('hidden');
                        updateLoadingStatus("User authenticated. Setting up profile...");
                        handleSuccessfulAuth(); 
                    } else {
                        // No user, show the login screen
                        currentUserId = null;
                        document.getElementById('loading-overlay').classList.add('hidden');
                        document.getElementById('login-screen').classList.remove('hidden');
                        updateLoadingStatus("Please enter your Access Code.");
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('login-error').textContent = `Initialization failed: ${error.message}`;
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }
        
        window.handleLogin = async function() {
            const codeInput = document.getElementById('access-code-input');
            const code = codeInput.value.trim();
            const errorText = document.getElementById('login-error');
            errorText.textContent = '';
            
            if (code.length !== 10 || isNaN(code)) {
                errorText.textContent = 'Access Code must be 10 numeric digits.';
                return;
            }

            document.getElementById('login-button').disabled = true;
            document.getElementById('login-button').textContent = 'Logging In...';
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('loading-overlay').classList.remove('hidden');
            updateLoadingStatus("Authenticating with server...");

            try {
                // Fetch a Custom Token from an external service (or mock token generation)
                // Since we cannot run an actual server, we will **MOCK** the token generation 
                // and use the code as the UID to simulate successful custom sign-in.
                
                // NOTE: In a real app, this would be a network call:
                // const tokenResponse = await fetch('/generateCustomToken', { method: 'POST', body: JSON.stringify({ code }) });
                // const { customToken } = await tokenResponse.json();
                
                // For this environment, we simulate success and rely on the platform's ability
                // to authenticate based on the UID/Code.
                
                const customToken = initialAuthToken || 'mock-token-' + code; // Must use a real token in production

                // Since we rely on the platform for token exchange, we only proceed to profile setup.
                // If the user's UID already exists, it will be automatically signed in via onAuthStateChanged.
                // For now, we will assume successful authentication based on the code/UID.
                
                // We will rely on onAuthStateChanged to pick up the user when the platform authenticates it.
                // We directly attempt profile setup based on the code/UID.
                await createOrFetchUserProfile(code);
                
            } catch (error) {
                console.error("Login failed:", error);
                errorText.textContent = `Login Failed: ${error.message}. Please try again.`;
                document.getElementById('login-button').disabled = false;
                document.getElementById('login-button').textContent = 'ENTER';
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }


        async function createOrFetchUserProfile(uid) {
            if (!uid || !db) return false;
            
            currentUserId = uid; // Set the UID temporarily for profile check
            updateLoadingStatus("Fetching user profile...");

            const userDocRef = doc(db, USERS_COLLECTION, uid);
            try {
                const docSnap = await getDoc(userDocRef);
                
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    isAdmin = currentUserData.isAdmin || false;
                } else {
                    // This is a new user/code. Set up a basic profile.
                    const newProfile = {
                        userId: uid,
                        username: `User-${uid.substring(uid.length - 4)}`,
                        tag: uid.substring(uid.length - 4),
                        pfpUrl: `https://placehold.co/80x80/${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}/ffffff?text=${uid.substring(uid.length - 4)}`,
                        isAdmin: false, 
                        isAnonymous: false,
                        accessCode: uid // Store the code as the access identifier
                    };
                    await setDoc(userDocRef, newProfile);
                    currentUserData = newProfile;
                    showMessageBox("Welcome!", "New profile created based on your access code.", 4000, 'bg-green-600');
                }
                
                // Update last online timestamp and set online flag
                await updateDoc(userDocRef, { 
                    lastOnline: serverTimestamp(),
                    isOnline: true
                }).catch(e => {
                    // If update fails, setDoc is needed for the first time
                    setDoc(userDocRef, { lastOnline: serverTimestamp(), isOnline: true }, { merge: true });
                });
                
                // Finalize setup
                handleSuccessfulAuth(); 
                return true;
            } catch (e) {
                console.error("Error creating/fetching profile:", e);
                updateLoadingStatus(`Profile Error: ${e.message}`);
                showMessageBox("Profile Error", "Could not access user profiles. Check Firestore rules.", 8000, 'bg-red-700');
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                return false;
            }
        }

        async function handleSuccessfulAuth() {
            if (!currentUserId || !currentUserData) return;
            
            updateLoadingStatus("Profile loaded. Starting chat listeners...");
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            setupGlobalListeners();
            updateProfileDisplay();
            // Start with the default channel
            switchChannel(activeChannelId); 
            document.getElementById('channel-title').textContent = PUBLIC_CHANNELS.find(c => c.id === activeChannelId).name;
        }
        
        // --- GLOBAL LISTENERS (Users) ---

        function setupGlobalListeners() {
            if (unsubscribeUsers) unsubscribeUsers();
            if (!isAuthReady || !currentUserId) return;
            
            const usersRef = collection(db, USERS_COLLECTION);
            
            unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
                const users = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Do not show the current user in the DM/User list panel
                    if (data.userId !== currentUserId) {
                        users.push({ ...data, id: doc.id });
                    }
                });
                renderUserList(users);
            }, (error) => {
                console.error("Error fetching users:", error);
                showMessageBox("User List Error", "Cannot fetch users. Check rules for the USERS collection.", 5000, 'bg-red-500');
            });
            
             // Presence tracking (Updates every 10 seconds while tab is active)
             setInterval(async () => {
                if (currentUserId && db) {
                    try {
                        await updateDoc(doc(db, USERS_COLLECTION, currentUserId), {
                            lastOnline: serverTimestamp(),
                            isOnline: true 
                        });
                    } catch (e) {
                        // Suppress frequent presence update errors
                    }
                }
            }, 10000); 
        }
        
        // --- CHAT STATE AND SWITCHING ---
        
        function switchMode(mode, targetId = null) {
            currentMode = mode;
            activeDmPartnerId = null;
            activeChannelId = null;

            if (unsubscribeMessages) unsubscribeMessages();

            const chatHeader = document.getElementById('chat-header');
            const userListTitle = document.getElementById('user-list-title');

            if (mode === 'channels') {
                activeChannelId = targetId || 'global';
                chatHeader.innerHTML = `<span class="text-secondary">#</span> ${PUBLIC_CHANNELS.find(c => c.id === activeChannelId).name}`;
                userListTitle.textContent = 'Users in Server';
                document.getElementById('channel-panel').classList.remove('hidden');
                document.getElementById('dm-list').classList.add('hidden');
                listenToChannelMessages(activeChannelId);
            } else if (mode === 'dms') {
                activeDmPartnerId = targetId;
                const partner = document.getElementById(`user-${targetId}`).dataset;
                chatHeader.innerHTML = `<span class="text-green-400">@</span> ${partner.username} <span class="text-gray-400">#${partner.tag}</span>`;
                userListTitle.textContent = 'Direct Messages';
                document.getElementById('channel-panel').classList.add('hidden');
                document.getElementById('dm-list').classList.remove('hidden');
                listenToDmMessages(activeDmPartnerId);
            }
            // Close the emoji picker on context switch
            document.getElementById('emoji-picker').classList.add('opacity-0', 'pointer-events-none');
        }
        
        // Expose to global scope for button clicks
        window.switchChannel = function(channelId) {
            switchMode('channels', channelId);
            // Visually update the active channel
            document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('bg-primary/30', 'border-primary'));
            document.getElementById(`channel-${channelId}`).classList.add('bg-primary/30', 'border-primary');
        }

        window.startDm = function(partnerId) {
             if (partnerId === currentUserId) {
                 showMessageBox("Wait!", "You can't DM yourself.", 3000, 'bg-yellow-500');
                 return;
             }
            switchMode('dms', partnerId);
            // Visually update the active user
            document.querySelectorAll('.user-dm-item').forEach(el => el.classList.remove('bg-gray-700'));
            document.getElementById(`user-${partnerId}`).classList.add('bg-gray-700');
        }

        // --- MESSAGE LISTENERS ---

        function listenToChannelMessages(channelId) {
            if (unsubscribeMessages) unsubscribeMessages();
            document.getElementById('chat-box').innerHTML = '<div class="text-center text-gray-500 py-4">Loading messages...</div>';

            const messagesRef = collection(db, PUBLIC_MESSAGES_COLLECTION);
            const messagesQuery = query(messagesRef, where('channelId', '==', channelId));

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    messages.push({ ...data, id: doc.id, timestamp: data.timestamp ? data.timestamp.toDate() : new Date(0) });
                });
                messages.sort((a, b) => a.timestamp - b.timestamp);
                renderMessages(messages);
            }, (error) => {
                console.error("Error fetching channel messages:", error);
                renderErrorInChatBox("CHANNEL", PUBLIC_MESSAGES_COLLECTION, error.message);
            });
        }
        
        function listenToDmMessages(partnerId) {
            if (unsubscribeMessages) unsubscribeMessages();
            document.getElementById('chat-box').innerHTML = '<div class="text-center text-gray-500 py-4">Loading DMs...</div>';

            const chatId = getDmConversationId(currentUserId, partnerId);
            // DM messages are stored as a subcollection under a unique document ID
            const dmMessagesRef = collection(db, DMS_COLLECTION, chatId, 'messages');

            const dmQuery = query(dmMessagesRef);

            unsubscribeMessages = onSnapshot(dmQuery, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    messages.push({ ...data, id: doc.id, timestamp: data.timestamp ? data.timestamp.toDate() : new Date(0) });
                });
                messages.sort((a, b) => a.timestamp - b.timestamp);
                renderMessages(messages);
            }, (error) => {
                console.error("Error fetching DM messages:", error);
                renderErrorInChatBox("DM", `${DMS_COLLECTION}/${chatId}/messages`, error.message);
            });
        }
        
        function renderErrorInChatBox(type, path, message) {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = `
                <div class="text-center bg-red-900/50 p-6 rounded-xl text-white font-semibold mx-4 mt-4 border border-red-700">
                    <p class="text-xl mb-2">${type} ACCESS DENIED</p>
                    <p class="text-sm">Cannot read messages due to a permissions issue.</p>
                    <p class="text-xs mt-3 font-mono break-all text-red-300">Path: ${path}</p>
                    <p class="text-xs font-mono mt-1 text-red-400">Error: ${escapeHTML(message)}</p>
                </div>
            `;
            showMessageBox("Permissions Error", `Failed to load ${type} chat. Check Firestore rules.`, 10000, 'bg-red-700');
        }

        // --- MESSAGE SENDING ---

        window.sendMessage = async function() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if (!content || !currentUserId || !currentUserData) return;
            
            const baseMessage = {
                userId: currentUserId,
                username: currentUserData.username,
                tag: currentUserData.tag,
                content: content,
                pfpUrl: currentUserData.pfpUrl,
                timestamp: serverTimestamp()
            };

            try {
                if (currentMode === 'channels') {
                    // Public Channel Message
                    const message = { ...baseMessage, channelId: activeChannelId };
                    await addDoc(collection(db, PUBLIC_MESSAGES_COLLECTION), message);
                } else if (currentMode === 'dms' && activeDmPartnerId) {
                    // Direct Message
                    const chatId = getDmConversationId(currentUserId, activeDmPartnerId);
                    const dmMessagesRef = collection(db, DMS_COLLECTION, chatId, 'messages');
                    const message = { ...baseMessage, senderId: currentUserId };
                    await addDoc(dmMessagesRef, message);
                } else {
                    showMessageBox("Error", "No active chat selected.", 3000, 'bg-yellow-500');
                    return;
                }
                input.value = ''; // Clear input on success
            } catch (error) {
                console.error("Error sending message:", error);
                showMessageBox("Error", "Failed to send message. Check Firestore write permissions.", 8000, 'bg-red-700');
            }
        }
        
        // Allows sending message via ENTER key
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('message-input');
            if (input) {
                input.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        window.sendMessage();
                    }
                });
            }
            // Initialize channel list rendering
            renderChannelList();
        });

        // --- UI RENDERING ---

        function renderMessages(messages) {
            const chatBox = document.getElementById('chat-box');
            // Do not overwrite error messages
            if (chatBox.querySelector('.bg-red-900\\/50')) return; 

            let wasScrolledToBottom = chatBox.scrollHeight - chatBox.clientHeight <= chatBox.scrollTop + chatBox.clientHeight * 0.1;

            chatBox.innerHTML = ''; 

            messages.forEach(msg => {
                const isMine = msg.userId === currentUserId || msg.senderId === currentUserId;
                const username = msg.username || (msg.senderId === currentUserId ? currentUserData.username : (document.getElementById(`user-${msg.senderId}`)?.dataset.username || '...'));
                const tag = msg.tag || (msg.senderId === currentUserId ? currentUserData.tag : (document.getElementById(`user-${msg.senderId}`)?.dataset.tag || '0000'));
                const pfpUrl = msg.pfpUrl || (msg.senderId === currentUserId ? currentUserData.pfpUrl : 'https://placehold.co/80x80/6B7280/ffffff?text=U');
                
                const messageHtml = `
                    <div class="flex items-start space-x-3 p-2 hover:bg-gray-800 transition-colors rounded-lg">
                        <img src="${pfpUrl}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/6B7280/ffffff?text=U'" class="w-10 h-10 rounded-full flex-shrink-0">
                        <div class="flex flex-col w-full">
                            <div class="flex items-baseline space-x-2">
                                <span class="text-sm font-semibold ${isMine ? 'text-primary' : 'text-blue-400'}">${username}</span>
                                <span class="text-xs text-gray-500">#${tag}</span>
                                <span class="text-xs text-gray-500">${msg.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                                ${isAdmin ? `<button onclick="window.deleteMessage('${msg.id}')" class="text-red-500 hover:text-red-400 text-xs ml-auto">Delete</button>` : ''}
                            </div>
                            <p class="text-sm text-gray-300 break-words whitespace-pre-wrap">${escapeHTML(msg.content)}</p>
                        </div>
                    </div>
                `;
                chatBox.insertAdjacentHTML('beforeend', messageHtml);
            });

            if (wasScrolledToBottom) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
        
        function renderChannelList() {
            const channelPanel = document.getElementById('channel-panel');
            channelPanel.innerHTML = '';

            PUBLIC_CHANNELS.forEach(channel => {
                const isActive = channel.id === activeChannelId;
                const channelHtml = `
                    <div id="channel-${channel.id}" onclick="switchChannel('${channel.id}')" 
                         class="channel-item flex items-center p-2 rounded-lg cursor-pointer transition-all duration-150 border-2 border-transparent ${isActive ? 'bg-primary/30 border-primary' : 'hover:bg-gray-700/50'}">
                        <span class="text-xl mr-3">${channel.icon}</span>
                        <span class="font-medium truncate">${channel.name}</span>
                    </div>
                `;
                channelPanel.insertAdjacentHTML('beforeend', channelHtml);
            });
        }

        function renderUserList(users) {
            const userList = document.getElementById('user-list');
            const dmList = document.getElementById('dm-list');
            userList.innerHTML = '';
            dmList.innerHTML = '';
            
            const now = Date.now();
            const onlineUsers = users.filter(u => u.isOnline && (u.lastOnline && (now - (u.lastOnline.toMillis ? u.lastOnline.toMillis() : u.lastOnline)) < 30000));
            
            const renderUser = (user, isOnline) => {
                 const statusColor = isOnline ? 'bg-green-500' : 'bg-gray-500';
                 const statusText = isOnline ? 'Online' : 'Offline';
                 
                 return `
                    <div id="user-${user.userId}" data-username="${user.username}" data-tag="${user.tag}" onclick="startDm('${user.userId}')" 
                         class="user-dm-item flex items-center p-2 rounded-lg hover:bg-gray-800 transition-colors cursor-pointer" >
                        <div class="relative mr-3">
                            <img src="${user.pfpUrl}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/6B7280/ffffff?text=U'" class="w-8 h-8 rounded-full">
                            <span class="absolute bottom-0 right-0 w-2.5 h-2.5 ${statusColor} rounded-full border-2 border-dark-sidebar" title="${statusText}"></span>
                        </div>
                        <div class="flex flex-col min-w-0">
                            <div class="flex items-center space-x-1 min-w-0">
                                <span class="text-sm font-medium text-gray-200 truncate">${user.username}</span>
                            </div>
                            <span class="text-xs text-gray-500">#${user.tag}</span>
                        </div>
                    </div>
                 `;
            };

            // Users in Server Panel
            userList.insertAdjacentHTML('beforeend', `<h3 class="text-xs font-semibold text-gray-400 uppercase mt-4 mb-2 px-2">Online Users - ${onlineUsers.length}</h3>`);
            onlineUsers.forEach(user => userList.insertAdjacentHTML('beforeend', renderUser(user, true)));
            
            // DM List (Shows all non-self users)
            users.forEach(user => dmList.insertAdjacentHTML('beforeend', renderUser(user, onlineUsers.some(u => u.userId === user.userId))));

            document.getElementById('online-user-count').textContent = onlineUsers.length;
        }

        function updateProfileDisplay() {
            if (!currentUserData) return;
            const profileDisplay = document.getElementById('profile-display');
            
            profileDisplay.innerHTML = `
                <div class="flex items-center space-x-3">
                    <img src="${currentUserData.pfpUrl}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/6B7280/ffffff?text=U'" class="w-10 h-10 rounded-full">
                    <div class="flex flex-col min-w-0">
                        <span class="text-base font-semibold text-primary truncate">${currentUserData.username}</span>
                        <span class="text-xs text-gray-400">#${currentUserData.tag}</span>
                    </div>
                </div>
                <div class="text-xs text-gray-500 mt-2 p-1 bg-gray-700/50 rounded-md break-all">
                    Access Code (UID): ${currentUserId}
                </div>
            `;
        }

        // --- EMOJI PICKER LOGIC ---
        
        const emojis = ['üëç', 'üëã', 'üòÇ', 'üò≠', 'ü§Ø', 'üçï', 'üíª', 'üí°', '‚úÖ', '‚ùå', '‚ù§Ô∏è', 'üî•', 'üéâ', 'üåü', 'üìö', '‚úèÔ∏è', 'üíØ', 'üôè'];

        window.toggleEmojiPicker = function() {
            const picker = document.getElementById('emoji-picker');
            picker.classList.toggle('opacity-0');
            picker.classList.toggle('pointer-events-none');
            // If showing, ensure the list is rendered
            if (!picker.classList.contains('opacity-0') && picker.children.length === 0) {
                emojis.forEach(emoji => {
                    const button = document.createElement('button');
                    button.textContent = emoji;
                    button.className = 'text-2xl hover:bg-gray-600 p-1.5 rounded-md transition-colors';
                    button.onclick = () => insertEmoji(emoji);
                    picker.appendChild(button);
                });
            }
        }
        
        function insertEmoji(emoji) {
            const input = document.getElementById('message-input');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;

            input.value = value.substring(0, start) + emoji + value.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + emoji.length;
            window.toggleEmojiPicker(); // Close after selection
        }

        // --- MODAL LOGIC (for confirmation) ---
        let modalCallback = null;

        window.showModal = function(message, callback) {
            const modal = document.getElementById('confirmationModal');
            const modalMessage = document.getElementById('confirmationModal-message');
            
            modalMessage.textContent = message;
            modalCallback = callback;
            modal.classList.remove('hidden');
        }

        window.closeModal = function() {
            document.getElementById('confirmationModal').classList.add('hidden');
            modalCallback = null;
        }
        
        window.confirmAction = function() {
            if (modalCallback) {
                modalCallback();
            }
            window.closeModal();
        }
        
        window.deleteMessage = function(messageId) {
            if (!isAdmin) {
                 showMessageBox("Permission Denied", "Only administrators can delete messages.", 3000, 'bg-red-500');
                 return;
            }
            
            window.showModal('Are you sure you want to permanently delete this message?', () => confirmDelete(messageId));
        }
        
        async function confirmDelete(messageId) {
            try {
                // Determine if we are deleting a public or a DM message
                if (currentMode === 'channels') {
                     await deleteDoc(doc(db, PUBLIC_MESSAGES_COLLECTION, messageId));
                } else if (currentMode === 'dms' && activeDmPartnerId) {
                    const chatId = getDmConversationId(currentUserId, activeDmPartnerId);
                    const dmMessagesRef = collection(db, DMS_COLLECTION, chatId, 'messages');
                    await deleteDoc(doc(dmMessagesRef, messageId));
                }
                showMessageBox("Success", "Message deleted.", 2000, 'bg-green-600');
            } catch (error) {
                console.error("Error deleting message:", error);
                showMessageBox("Error", "Failed to delete message. Check Firestore rules for write access.", 3000, 'bg-red-500');
            }
        }

        // --- INIT CALL ---
        window.onload = initFirebase;
    </script>

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-900 z-50 p-6 hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm border border-gray-700 text-center">
            <h1 class="text-3xl font-extrabold text-primary mb-4">Welcome to School Chat</h1>
            <p class="text-gray-400 mb-6">Enter your **10-digit Access Code** to join or re-enable chat.</p>
            
            <input type="number" id="access-code-input" placeholder="Enter 10-digit Code" 
                   class="w-full p-3 mb-4 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary text-center text-xl tracking-widest"
                   maxlength="10" oninput="if(this.value.length>this.maxLength)this.value=this.value.slice(0,this.maxLength)">
            
            <button id="login-button" onclick="handleLogin()"
                    class="w-full bg-primary hover:bg-secondary text-white font-bold py-3 rounded-xl transition-all duration-200 transform hover:scale-[1.01]">
                ENTER
            </button>
            
            <p id="login-error" class="text-red-500 text-sm mt-4"></p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 flex flex-col items-center justify-center bg-gray-900 z-50 transition-opacity duration-500">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-700 h-12 w-12 mb-4"></div>
        <p id="loading-status" class="text-gray-400">Initializing Firebase...</p>
        <style>
            .loader {
                border-top-color: #6366f1;
                -webkit-animation: spinner 1.5s linear infinite;
                animation: spinner 1.5s linear infinite;
            }
            @-webkit-keyframes spinner { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
            @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        </style>
    </div>

    <div id="app-container" class="hidden chat-container rounded-xl shadow-2xl overflow-hidden border border-gray-800">
        
        <!-- Panel 1: Servers/DMs Selector -->
        <div class="w-[70px] bg-dark-sidebar p-2 flex flex-col items-center space-y-3 border-r border-gray-800">
            <h1 class="text-2xl font-bold text-primary">C<span class="text-secondary">h</span>at</h1>

            <button onclick="switchMode('channels')" 
                    class="p-2.5 rounded-xl bg-primary/20 text-white hover:bg-primary transition-all duration-150 transform hover:scale-105 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-text"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M13 8H7"/><path d="M17 12H7"/></svg>
            </button>
            <button onclick="switchMode('dms')"
                    class="p-2.5 rounded-xl bg-gray-600/50 text-white hover:bg-secondary transition-all duration-150 transform hover:scale-105 shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail-open"><path d="M22 7.5l-8.4 5.6-3.6-2.4-3.6 2.4L2 7.5"/><path d="M2 7.5V19a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7.5"/><path d="M10 10l-6-4"/><path d="M20 6l-6 4"/></svg>
            </button>
        </div>

        <!-- Panel 2: Channels / DM List / Users -->
        <div class="w-1/4 bg-gray-800 p-4 flex flex-col border-r border-gray-800 custom-scroll">
            <h2 id="user-list-title" class="text-lg font-bold text-white mb-4">Channels</h2>
            
            <!-- Channels List -->
            <div id="channel-panel" class="flex-grow space-y-2 mb-6">
                <!-- Channels rendered here -->
            </div>

            <!-- DM List (Hidden by default) -->
            <div id="dm-list" class="flex-grow space-y-1 hidden">
                <h3 class="text-xs font-semibold text-gray-400 uppercase mt-2 mb-2 px-2">Start DM</h3>
                <!-- DM users rendered here -->
            </div>

            <!-- Users in Channel List (Hidden when DMs active) -->
            <div id="user-list" class="flex-grow space-y-1">
                <!-- Users rendered here -->
            </div>
            
            <!-- Profile Footer -->
            <div id="profile-display" class="mt-4 p-3 bg-dark-panel rounded-xl shadow-inner border border-gray-700">
                <!-- Profile details will be rendered here -->
            </div>
        </div>

        <!-- Panel 3: Chat Area -->
        <div class="flex-grow flex flex-col bg-gray-900">
            <!-- Header -->
            <header class="bg-gray-800 p-3 border-b border-gray-700 shadow-md flex items-center">
                <h1 id="chat-header" class="text-xl font-extrabold text-white">
                    <span class="text-secondary">#</span> Global Chat
                </h1>
                <span class="ml-auto text-sm text-gray-400">Online: <span id="online-user-count">...</span></span>
            </header>

            <!-- Messages Box -->
            <div id="chat-box" class="flex-grow overflow-y-auto p-4 space-y-3 custom-scroll">
                <!-- Messages will be rendered here -->
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-gray-800 border-t border-gray-700 relative">
                <div id="emoji-picker" class="absolute bottom-20 left-4 bg-dark-panel p-3 rounded-xl shadow-2xl border border-gray-700 grid grid-cols-6 gap-2 opacity-0 pointer-events-none z-10">
                    <!-- Emojis rendered here -->
                </div>

                <div class="flex space-x-3">
                    <button onclick="toggleEmojiPicker()"
                            class="p-3 rounded-xl bg-gray-700 text-yellow-400 hover:bg-gray-600 transition-colors transform hover:scale-[1.05]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-smile"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>
                    </button>
                    <input type="text" id="message-input" placeholder="Type a message and press Enter..." 
                           class="flex-grow p-3 rounded-xl bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-primary placeholder-gray-400 transition-colors"
                           maxlength="500">
                    <button onclick="sendMessage()"
                            class="bg-primary hover:bg-secondary text-white font-bold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-[1.02] shadow-lg shadow-primary/30">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Message Container -->
    <div id="message-box-container" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-70 hidden z-[100] flex items-center justify-center">
        <div class="bg-dark-panel p-6 rounded-xl shadow-2xl w-full max-w-sm text-center border border-gray-700">
            <p id="confirmationModal-message" class="text-lg font-semibold text-gray-100 mb-6">Are you sure?</p>
            <div class="flex justify-center space-x-4">
                <button onclick="confirmAction()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Confirm
                </button>
                <button onclick="closeModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>