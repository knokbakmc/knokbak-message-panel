<div class="min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center p-4">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 
        ==================================================================
        MANDATORY SECURITY RULES SCRIPT
        This script ensures that any authenticated user (including anonymous 
        sign-ins used for access code login) has READ/WRITE access to the 
        public collections (/artifacts/{appId}/public/data/...).
        This fixes the "Insufficient Permissions" error.
        ==================================================================
    -->
    <script type="text/javascript">
        window.onload = function() {
            // Check if the environment provides a function to apply rules
            if (typeof __set_firestore_security_rules === 'function') {
                const PUBLIC_RULE_SCRIPT = `
service cloud.firestore {
  match /databases/{database}/documents {
    // ALLOW PUBLIC READ AND WRITE FOR ALL AUTHENTICATED USERS (request.auth != null)
    match /artifacts/{appId}/public/data/{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
`;
                __set_firestore_security_rules(PUBLIC_RULE_SCRIPT);
                console.log("Firestore security rules set to public access for authenticated users.");
            } else {
                console.warn("Could not find __set_firestore_security_rules function. Firestore access may be limited.");
            }
        };
    </script>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- HARDCODED DEFAULT FIREBASE CONFIG ---
        // This is used if the environment variable is missing. 
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyC_YourDefaultApiKeyGoesHere_DoNotShareInPublic", 
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890"
        };
        // -----------------------------------------

        // Global Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // **Firebase Config setup**
        let firebaseConfig;
        try {
            const envConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            const parsedConfig = JSON.parse(envConfig);
            firebaseConfig = (parsedConfig && parsedConfig.apiKey) ? parsedConfig : defaultFirebaseConfig;
        } catch (e) {
            console.warn("Could not parse environment Firebase config. Using default config.");
            firebaseConfig = defaultFirebaseConfig;
        }

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let currentUserData = null; // Stores user profile data
        let currentServerId = 'global'; // Start on 'global'
        let unsubscribeMessages = null;
        let unsubscribeUsers = null;
        let isAdmin = false;
        let isAuthReady = false;

        // NOTE: Garrett is now the Admin based on the code you provided (5815287646)
        const ADMIN_ID = "5815287646"; 
        const ADMIN_PASSWORD = "mysubsarethebest";
        const MESSAGES_COLLECTION_PATH = `/artifacts/${appId}/public/data/messages`;
        const USERS_COLLECTION_PATH = `/artifacts/${appId}/public/data/users`;
        const CODES_COLLECTION_PATH = `/artifacts/${appId}/public/data/codes`; 
        
        // --- SEEDED PROFILE DATA (UPDATED WITH NEW CODES) ---
        const SEEDED_PROFILES = [
            { username: "David", tag: "1001", accessCode: "2879556054", pfpUrl: "https://placehold.co/80x80/2563EB/ffffff?text=D" },
            { username: "Amir", tag: "1002", accessCode: "4774321694", pfpUrl: "https://placehold.co/80x80/059669/ffffff?text=A" },
            { username: "Camden", tag: "1003", accessCode: "0009029674", pfpUrl: "https://placehold.co/80x80/9333EA/ffffff?text=C" },
            { username: "Garrett", tag: "1004", accessCode: "5815287646", pfpUrl: "https://placehold.co/80x80/FBBF24/000000?text=G" },
            { username: "Isaac", tag: "1005", accessCode: "0269927548", pfpUrl: "https://placehold.co/80x80/EC4899/ffffff?text=I" },
        ];
        
        // --- Utility Functions ---

        // Simple debounce function to limit function calls
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // --- Auth and Init ---

        async function initFirebase() {
            try {
                if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes('YourDefaultApiKeyGoesHere')) {
                    document.getElementById('loading-status').textContent = "Initialization: Using Default/Placeholder Firebase config.";
                } else {
                     document.getElementById('loading-status').textContent = "Initialization: Using environment-provided Firebase config.";
                }
                
                setLogLevel('error'); 
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await setPersistence(auth, browserSessionPersistence);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Seed default users now that DB is initialized
                await seedDefaultUsersIfNecessary();

                // Wait for auth state to be resolved
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        currentUserId = user.uid;
                        isAdmin = currentUserId === ADMIN_ID;
                        document.getElementById('loading-status').textContent = "Authenticated successfully. Loading profile...";
                        handleSuccessfulAuth(true); // Call with true to indicate full auth
                    } else {
                        currentUserId = null;
                        isAdmin = false;
                        document.getElementById('loading-status').textContent = "Waiting for login...";
                        handleSuccessfulAuth(false); // Call with false to indicate no full auth
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loading-status').textContent = `Initialization Error: ${error.message}`;
                showModal('errorModal', `Firebase initialization failed. Check console for details. Error: ${error.message}`);
            }
        }

        async function seedDefaultUsersIfNecessary() {
            try {
                // We check if the codes collection has at least one document.
                const codesRef = collection(db, CODES_COLLECTION_PATH);
                const codesSnapshot = await getDocs(query(codesRef));

                if (codesSnapshot.empty) {
                    console.log("Seeding default users...");
                    for (const profile of SEEDED_PROFILES) {
                        // 1. Check if the code exists
                        const codeQuery = query(codesRef, where('accessCode', '==', profile.accessCode));
                        const existingCodeDocs = await getDocs(codeQuery);
                        
                        if (existingCodeDocs.empty) {
                             // 2. Create a placeholder user document (without actual authentication)
                             // We use a generated UUID as the UID for the placeholder
                            const placeholderUid = crypto.randomUUID(); 

                            // 3. Create the profile in the users collection
                            await setDoc(doc(db, USERS_COLLECTION_PATH, placeholderUid), {
                                userId: placeholderUid,
                                username: profile.username,
                                tag: profile.tag,
                                pfpUrl: profile.pfpUrl,
                                isAdmin: profile.accessCode === ADMIN_ID,
                                lastOnline: serverTimestamp()
                            });

                            // 4. Create the access code entry
                            await setDoc(doc(db, CODES_COLLECTION_PATH, profile.accessCode), {
                                accessCode: profile.accessCode,
                                userId: placeholderUid,
                                username: profile.username, // For display in code list
                                isSeeded: true
                            });
                        }
                    }
                    console.log("Default users seeded successfully.");
                } else {
                    // Update seeded profiles just in case the codes changed (like in this request)
                    for (const profile of SEEDED_PROFILES) {
                         const codesRef = collection(db, CODES_COLLECTION_PATH);
                         const codeDocRef = doc(codesRef, profile.accessCode);
                         
                         // Try to get the existing code document
                         const codeDoc = await getDoc(codeDocRef);
                         
                         if (codeDoc.exists()) {
                            const existingData = codeDoc.data();
                            // If the code already points to a user, update the user's profile
                            if (existingData.userId) {
                                const userDocRef = doc(db, USERS_COLLECTION_PATH, existingData.userId);
                                await updateDoc(userDocRef, {
                                    username: profile.username,
                                    tag: profile.tag,
                                    isAdmin: profile.accessCode === ADMIN_ID,
                                });
                            }
                         } else {
                            // If the code doesn't exist, create it (handles new or missing seed codes)
                            const placeholderUid = crypto.randomUUID(); 
                            const userDocRef = doc(db, USERS_COLLECTION_PATH, placeholderUid);
                            
                            await setDoc(userDocRef, {
                                userId: placeholderUid,
                                username: profile.username,
                                tag: profile.tag,
                                pfpUrl: profile.pfpUrl,
                                isAdmin: profile.accessCode === ADMIN_ID,
                                lastOnline: serverTimestamp()
                            });

                            await setDoc(codeDocRef, {
                                accessCode: profile.accessCode,
                                userId: placeholderUid,
                                username: profile.username,
                                isSeeded: true
                            });
                         }
                    }
                }
            } catch (error) {
                console.error("Error seeding default users:", error);
            }
        }
        
        // Custom Auth with Access Code
        async function authenticateWithCode(accessCode) {
            const code = accessCode.trim();
            if (code.length !== 10) {
                 showMessageBox("Error", "Access code must be exactly 10 digits long.", 3000, 'bg-red-500');
                 return;
            }

            try {
                // 1. Check the CODES collection for the access code
                const codeDocRef = doc(db, CODES_COLLECTION_PATH, code);
                const codeDoc = await getDoc(codeDocRef);

                if (!codeDoc.exists()) {
                    showMessageBox("Error", "Invalid Access Code. Please try again.", 3000, 'bg-red-500');
                    return;
                }

                const userData = codeDoc.data();
                const targetUserId = userData.userId;

                // 2. Fetch the target user's profile
                const userDocRef = doc(db, USERS_COLLECTION_PATH, targetUserId);
                const userDoc = await getDoc(userDocRef);
                
                if (!userDoc.exists()) {
                     showMessageBox("Error", "User profile missing. Please contact support.", 3000, 'bg-red-500');
                     return;
                }

                // 3. Sign in anonymously (if not already signed in with a permanent ID)
                const { user } = await signInAnonymously(auth);
                
                // 4. Update the current anonymous user's profile with the target user's data
                const userProfile = userDoc.data();

                await setDoc(doc(db, USERS_COLLECTION_PATH, user.uid), {
                    // Copy data from the target user to the current authenticated user's ID
                    ...userProfile,
                    userId: user.uid, // Use the new authenticated UID
                    // The username and tag from the original profile remain
                    lastOnline: serverTimestamp()
                });

                // 5. Update the code to point to the new authenticated user's UID
                await updateDoc(codeDocRef, {
                    userId: user.uid,
                    // Keep isSeeded true for easy identification
                });

                // 6. Log in successful (onAuthStateChanged will handle the rest)
                closeModal('loginModal');
                showMessageBox("Success", `Welcome back, ${userProfile.username}!`, 3000, 'bg-green-600');
                // The onAuthStateChanged listener will fire and call handleSuccessfulAuth(true)
                
            } catch (error) {
                console.error("Login failed:", error);
                showMessageBox("Error", `Login Failed: ${error.message}`, 5000, 'bg-red-500');
            }
        }

        async function createNewUser(username) {
            const name = username.trim();
            if (!name) return;

            try {
                // 1. Sign in anonymously to get a UID
                const { user } = await signInAnonymously(auth);
                const newUserId = user.uid;
                
                // 2. Generate a unique 10-digit code
                let newCode;
                let codeExists = true;
                while (codeExists) {
                    newCode = Math.floor(1000000000 + Math.random() * 9000000000).toString();
                    const codeDocRef = doc(db, CODES_COLLECTION_PATH, newCode);
                    const docSnap = await getDoc(codeDocRef);
                    codeExists = docSnap.exists();
                }

                // 3. Create the user profile
                await setDoc(doc(db, USERS_COLLECTION_PATH, newUserId), {
                    userId: newUserId,
                    username: name,
                    tag: newCode.substring(0, 4), // Use first 4 digits as initial tag
                    pfpUrl: `https://placehold.co/80x80/${Math.floor(Math.random()*16777215).toString(16)}/ffffff?text=${name.charAt(0)}`,
                    isAdmin: false,
                    lastOnline: serverTimestamp()
                });

                // 4. Create the access code entry
                await setDoc(doc(db, CODES_COLLECTION_PATH, newCode), {
                    accessCode: newCode,
                    userId: newUserId,
                    username: name,
                    isSeeded: false // Not a seeded profile
                });
                
                closeModal('newUserModal');
                showMessageBox("Success", `Profile created! Your code is: ${newCode}. Keep it safe!`, 5000, 'bg-green-600');
                // The onAuthStateChanged listener will fire and handle the final setup
                
            } catch (error) {
                console.error("User creation failed:", error);
                showMessageBox("Error", `Failed to create profile: ${error.message}`, 5000, 'bg-red-500');
            }
        }
        
        async function handleSuccessfulAuth(isAuthenticated) {
            if (!isAuthenticated) {
                currentUserId = null;
                currentUserData = null;
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('loading-overlay').classList.add('hidden');
                showModal('loginModal');
                return;
            }

            // Authentication succeeded, fetch user data and set up listeners
            await fetchAndSetUserData();
            
            if (currentUserData) {
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('loading-overlay').classList.add('hidden');
                setupListeners();
                updateProfileDisplay();
                // Close login modal if it's open
                closeModal('loginModal');
            } else {
                 // Fallback if profile doesn't exist (shouldn't happen with the current flow)
                 // This usually means the sign-in was too quick, we wait.
                 document.getElementById('loading-status').textContent = "Profile data still loading...";
            }
        }

        async function fetchAndSetUserData() {
            if (!currentUserId || !db) return;

            try {
                const userDocRef = doc(db, USERS_COLLECTION_PATH, currentUserId);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    isAdmin = currentUserData.isAdmin || false;
                } else {
                    // This scenario should only happen if a user is authenticated but their profile document was deleted
                    console.error("Authenticated user has no profile data.");
                    await signOut(auth); // Force log out
                }
            } catch (error) {
                console.error("Error fetching user data:", error);
                await signOut(auth);
            }
        }
        
        // --- Firestore Listeners ---

        function setupListeners() {
            // Stop existing listeners first
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeUsers) unsubscribeUsers();

            // 1. Messages Listener
            const messagesRef = collection(db, MESSAGES_COLLECTION_PATH);
            const messagesQuery = query(messagesRef, where('serverId', '==', currentServerId));

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    messages.push({ ...data, id: doc.id, timestamp: data.timestamp ? data.timestamp.toDate() : new Date() });
                });
                // Sort messages by timestamp
                messages.sort((a, b) => a.timestamp - b.timestamp);
                renderMessages(messages);
            }, (error) => {
                console.error("Error fetching messages:", error);
            });

            // 2. Users Listener
            const usersRef = collection(db, USERS_COLLECTION_PATH);
            
            unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
                const users = [];
                snapshot.forEach(doc => {
                    users.push({ ...doc.data(), id: doc.id });
                });
                renderUserList(users);
            }, (error) => {
                console.error("Error fetching users:", error);
            });
            
             // 3. User Presence/Online Status (Debounced Update)
             const updateOnlineStatus = debounce(async (isOnline) => {
                if (currentUserId && db && currentUserData) {
                    try {
                         // We update the local user's own profile doc.
                        await updateDoc(doc(db, USERS_COLLECTION_PATH, currentUserId), {
                            lastOnline: isOnline ? serverTimestamp() : Date.now(),
                            isOnline: isOnline 
                        });
                    } catch (e) {
                        console.error("Failed to update presence:", e);
                    }
                }
            }, 1000); // 1-second debounce

            // Update status on load/active
            updateOnlineStatus(true);
            
            // Add global event listeners for presence tracking
            window.addEventListener('focus', () => updateOnlineStatus(true));
            window.addEventListener('blur', () => updateOnlineStatus(false));
            window.addEventListener('beforeunload', () => updateOnlineStatus(false));
        }

        // --- Message Handling ---

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if (!content || !currentUserId || !currentUserData) return;

            const message = {
                userId: currentUserId,
                username: currentUserData.username,
                tag: currentUserData.tag,
                content: content,
                pfpUrl: currentUserData.pfpUrl,
                serverId: currentServerId, // Currently 'global'
                timestamp: serverTimestamp()
            };

            try {
                await addDoc(collection(db, MESSAGES_COLLECTION_PATH), message);
                input.value = ''; // Clear input on success
            } catch (error) {
                console.error("Error sending message:", error);
                showMessageBox("Error", "Failed to send message.", 3000, 'bg-red-500');
            }
        }

        function renderMessages(messages) {
            const chatBox = document.getElementById('chat-box');
            let wasScrolledToBottom = chatBox.scrollHeight - chatBox.clientHeight <= chatBox.scrollTop + 1;

            chatBox.innerHTML = ''; // Clear previous messages

            messages.forEach(msg => {
                const isMine = msg.userId === currentUserId;
                const messageHtml = `
                    <div class="flex items-start space-x-3 p-2 hover:bg-gray-800 transition-colors">
                        <img src="${msg.pfpUrl}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/6B7280/ffffff?text=U'" class="w-10 h-10 rounded-full flex-shrink-0">
                        <div class="flex flex-col w-full">
                            <div class="flex items-baseline space-x-2">
                                <span class="text-sm font-semibold ${isMine ? 'text-green-400' : 'text-blue-400'}">${msg.username}</span>
                                <span class="text-xs text-gray-500">#${msg.tag}</span>
                                <span class="text-xs text-gray-500">${msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : '...'}</span>
                                ${isAdmin && !msg.isAdmin ? `<button onclick="window.deleteMessage('${msg.id}')" class="text-red-500 hover:text-red-400 text-xs ml-auto">Delete</button>` : ''}
                            </div>
                            <p class="text-sm text-gray-300 break-words whitespace-pre-wrap">${escapeHTML(msg.content)}</p>
                        </div>
                    </div>
                `;
                chatBox.insertAdjacentHTML('beforeend', messageHtml);
            });

            // Scroll to bottom only if the user was already near the bottom
            if (wasScrolledToBottom) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
        
        // Expose deleteMessage function globally for inline click handler
        window.deleteMessage = async function(messageId) {
            if (!isAdmin || !messageId) {
                 showMessageBox("Permission Denied", "Only administrators can delete messages.", 3000, 'bg-red-500');
                 return;
            }
            
            showModal('confirmationModal', 'Are you sure you want to delete this message?', () => confirmDelete(messageId));
        }
        
        async function confirmDelete(messageId) {
            closeModal('confirmationModal');
            try {
                await deleteDoc(doc(db, MESSAGES_COLLECTION_PATH, messageId));
                showMessageBox("Success", "Message deleted.", 2000, 'bg-green-600');
            } catch (error) {
                console.error("Error deleting message:", error);
                showMessageBox("Error", "Failed to delete message.", 3000, 'bg-red-500');
            }
        }
        
        // --- User List and Profile UI ---

        function renderUserList(users) {
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            
            // Separate online and offline users
            const now = Date.now();
            const onlineUsers = users.filter(u => u.isOnline === true || (now - u.lastOnline < 30000 && typeof u.lastOnline === 'number'));
            const offlineUsers = users.filter(u => u.isOnline === false || (now - u.lastOnline >= 30000 || typeof u.lastOnline !== 'number'));

            // Sort by username
            onlineUsers.sort((a, b) => a.username.localeCompare(b.username));
            offlineUsers.sort((a, b) => a.username.localeCompare(b.username));
            
            const renderUser = (user, isOnline) => {
                 const statusColor = isOnline ? 'bg-green-500' : 'bg-gray-500';
                 const statusText = isOnline ? 'Online' : 'Offline';
                 const isSelf = user.userId === currentUserId;
                 const adminBadge = user.isAdmin ? '<span class="text-xs font-bold text-red-400">ADMIN</span>' : '';
                 
                 return `
                    <div class="flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors ${isSelf ? 'bg-gray-700' : ''}">
                        <div class="relative mr-3">
                            <img src="${user.pfpUrl}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/6B7280/ffffff?text=U'" class="w-8 h-8 rounded-full">
                            <span class="absolute bottom-0 right-0 w-2.5 h-2.5 ${statusColor} rounded-full border-2 border-gray-800" title="${statusText}"></span>
                        </div>
                        <div class="flex flex-col min-w-0">
                            <div class="flex items-center space-x-1 min-w-0">
                                <span class="text-sm font-medium text-gray-200 truncate">${user.username}</span>
                                ${adminBadge}
                            </div>
                            <span class="text-xs text-gray-500">#${user.tag}</span>
                        </div>
                    </div>
                 `;
            };

            const appendGroup = (title, list, isOnline) => {
                if (list.length > 0) {
                     userList.insertAdjacentHTML('beforeend', `<h3 class="text-xs font-semibold text-gray-400 uppercase mt-4 mb-2 px-2">${title} - ${list.length}</h3>`);
                     list.forEach(user => userList.insertAdjacentHTML('beforeend', renderUser(user, isOnline)));
                }
            };
            
            appendGroup('Online', onlineUsers, true);
            appendGroup('Offline', offlineUsers, false);

            document.getElementById('user-count').textContent = users.length;
        }

        function updateProfileDisplay() {
            if (!currentUserData) return;
            const profileDisplay = document.getElementById('profile-display');
            
            profileDisplay.innerHTML = `
                <div class="flex items-center space-x-3">
                    <img src="${currentUserData.pfpUrl}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/6B7280/ffffff?text=U'" class="w-10 h-10 rounded-full">
                    <div class="flex flex-col min-w-0">
                        <span class="text-sm font-semibold text-white truncate">${currentUserData.username}</span>
                        <span class="text-xs text-gray-400">#${currentUserData.tag}</span>
                    </div>
                </div>
            `;
            
            // Populate settings modal inputs
            document.getElementById('setting-username').value = currentUserData.username || '';
            document.getElementById('setting-tag').value = currentUserData.tag || '';
            document.getElementById('setting-pfpurl').value = currentUserData.pfpUrl || '';
            document.getElementById('setting-userid').textContent = currentUserId || 'N/A';
            document.getElementById('setting-admin-status').textContent = isAdmin ? 'Yes' : 'No';
            document.getElementById('setting-access-code').textContent = 'Loading...';
            
            fetchAccessCode();
        }
        
        async function fetchAccessCode() {
             if (!currentUserId || !db) return;
             
             try {
                const codesRef = collection(db, CODES_COLLECTION_PATH);
                const codeQuery = query(codesRef, where('userId', '==', currentUserId));
                const snapshot = await getDocs(codeQuery);
                
                if (!snapshot.empty) {
                    const code = snapshot.docs[0].data().accessCode;
                    document.getElementById('setting-access-code').textContent = code;
                } else {
                    document.getElementById('setting-access-code').textContent = 'No Permanent Code';
                }
             } catch (error) {
                 console.error("Error fetching access code:", error);
                 document.getElementById('setting-access-code').textContent = 'Error';
             }
        }
        
        async function updateProfile() {
            if (!currentUserId || !db) return;

            const newUsername = document.getElementById('setting-username').value.trim();
            const newTag = document.getElementById('setting-tag').value.trim();
            const newPfpUrl = document.getElementById('setting-pfpurl').value.trim();

            if (!newUsername || !newTag || newTag.length > 8) {
                showMessageBox("Error", "Username cannot be empty, and Tag must be 1-8 characters.", 4000, 'bg-red-500');
                return;
            }
            
            try {
                // Update User Profile
                await updateDoc(doc(db, USERS_COLLECTION_PATH, currentUserId), {
                    username: newUsername,
                    tag: newTag,
                    pfpUrl: newPfpUrl
                });

                // Re-fetch and update local state
                await fetchAndSetUserData();
                updateProfileDisplay();
                
                // Update associated code entry for clarity (optional but helpful)
                const codesRef = collection(db, CODES_COLLECTION_PATH);
                const codeQuery = query(codesRef, where('userId', '==', currentUserId));
                const snapshot = await getDocs(codeQuery);
                
                if (!snapshot.empty) {
                    await updateDoc(snapshot.docs[0].ref, {
                        username: newUsername,
                    });
                }
                
                closeModal('settingsModal');
                showMessageBox("Success", "Profile updated successfully!", 3000, 'bg-green-600');

            } catch (error) {
                console.error("Error updating profile:", error);
                showMessageBox("Error", "Failed to update profile.", 3000, 'bg-red-500');
            }
        }
        
        // --- Modal/UI Controls ---
        
        function escapeHTML(str) {
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
        }

        function showModal(modalId, message = '', confirmAction = null) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            // Handle specific content for confirmation modal
            if (modalId === 'confirmationModal') {
                document.getElementById('confirmation-message').textContent = message;
                const confirmBtn = document.getElementById('confirm-action-btn');
                confirmBtn.onclick = () => confirmAction(); // Set the specific action
            }

            modal.classList.remove('hidden');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // --- Message Box UI (Non-blocking alerts) ---
        let messageBoxTimeout;
        function showMessageBox(title, message, duration = 3000, bgColor = 'bg-blue-500') {
            const msgBox = document.getElementById('message-box');
            const msgTitle = document.getElementById('message-box-title');
            const msgContent = document.getElementById('message-box-content');

            clearTimeout(messageBoxTimeout);

            msgBox.className = `fixed bottom-4 right-4 max-w-sm p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 z-50 ${bgColor}`;
            msgTitle.textContent = title;
            msgContent.textContent = message;
            msgBox.classList.remove('opacity-0');

            messageBoxTimeout = setTimeout(() => {
                msgBox.classList.add('opacity-0');
            }, duration);
        }
        
        // Assign global functions for HTML interaction
        window.sendMessage = sendMessage;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.updateProfile = updateProfile;
        window.authenticateWithCode = authenticateWithCode;
        window.createNewUser = createNewUser;
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', initFirebase);
        
        // Add event listener for the message input to allow sending with Enter key
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.id === 'message-input') {
                e.preventDefault();
                sendMessage();
            }
        });

    </script>

    <!-- Main Chat Application Container -->
    <div id="app-container" class="hidden w-full h-[90vh] max-w-6xl flex rounded-xl shadow-2xl overflow-hidden bg-gray-800">

        <!-- Sidebar (Channels and User Profile) -->
        <div class="w-20 bg-gray-900 flex flex-col items-center py-4 space-y-4">
            <!-- Server Icon -->
            <button class="w-12 h-12 bg-blue-600 hover:bg-blue-500 text-white font-bold text-lg rounded-xl flex items-center justify-center transition-all shadow-md active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
            </button>
            <!-- Add more servers/channels here -->
        </div>

        <!-- Channel List (Text Channels) -->
        <div class="w-56 bg-gray-700 flex flex-col justify-between">
            <div class="p-3">
                <h2 class="text-xl font-bold mb-4 text-white truncate">Global Chat</h2>
                <div class="space-y-1">
                    <button class="w-full text-left p-2 rounded-lg bg-gray-600 text-gray-200 font-semibold flex items-center transition-colors hover:bg-gray-500">
                        <span class="mr-2 text-lg">#</span> Global-Lounge
                    </button>
                    <!-- More channels here -->
                </div>
            </div>
            
            <!-- User Profile Box -->
            <div class="p-3 bg-gray-800 border-t border-gray-700">
                <button id="profile-display" onclick="showModal('settingsModal')" class="w-full text-left p-1 rounded-lg hover:bg-gray-600 transition-colors flex items-center space-x-2">
                    <!-- Profile data populated by JS -->
                </button>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Chat Header -->
            <header class="h-14 flex items-center px-4 border-b border-gray-700 shadow-md">
                <h1 class="text-lg font-semibold text-gray-200"># Global-Lounge</h1>
            </header>

            <!-- Messages Box -->
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                <!-- Messages will be rendered here -->
            </div>

            <!-- Message Input -->
            <div class="p-4">
                <div class="flex items-center bg-gray-700 rounded-lg p-2 shadow-lg">
                    <input id="message-input" type="text" placeholder="Message #Global-Lounge" class="flex-1 bg-transparent text-gray-200 placeholder-gray-400 focus:outline-none px-2 py-1">
                    <button onclick="sendMessage()" class="ml-2 p-2 rounded-full bg-blue-600 text-white hover:bg-blue-500 transition-colors active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.149.736A1 1 0 003 18h14a1 1 0 00.899-1.488l-7-14zM6 15a1 1 0 100-2 1 1 0 000 2z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- User List (Right Sidebar) -->
        <div class="w-56 bg-gray-700 flex flex-col flex-shrink-0 border-l border-gray-700 overflow-y-auto custom-scrollbar">
            <h3 class="text-xs font-semibold text-gray-400 uppercase mt-4 mb-2 px-3">Members (<span id="user-count">0</span>)</h3>
            <div id="user-list" class="flex flex-col p-1">
                <!-- User List populated by JS -->
            </div>
        </div>

    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="flex flex-col items-center space-y-4">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <p id="loading-status" class="text-lg text-gray-400">Initializing Firebase and authenticating...</p>
        </div>
    </div>
    
    <!-- Modals -->
    
    <!-- Base Modal Structure -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-3xl font-bold mb-4 text-white">Welcome Back!</h2>
            <p class="text-gray-400 mb-6">Enter your 10-digit **Access Code** to log in, or create a new profile.</p>

            <div class="space-y-4">
                <input id="login-access-code" type="text" placeholder="10-Digit Access Code" maxlength="10" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                <button onclick="authenticateWithCode(document.getElementById('login-access-code').value)" class="w-full py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-semibold transition-colors shadow-md">
                    Log In
                </button>
            </div>
            
            <div class="mt-6 pt-4 border-t border-gray-700">
                <p class="text-gray-400 mb-3">Don't have a code? Create a new user profile:</p>
                <button onclick="closeModal('loginModal'); showModal('newUserModal')" class="w-full py-2 rounded-lg bg-green-600 hover:bg-green-500 text-white font-semibold transition-colors">
                    Create New Profile
                </button>
            </div>
        </div>
    </div>
    
    <div id="newUserModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-3xl font-bold mb-4 text-white">Create New Profile</h2>
            <p class="text-gray-400 mb-6">Enter your desired username to get a new, unique access code.</p>

            <div class="space-y-4">
                <input id="new-user-username" type="text" placeholder="Choose a Username (e.g., JaneDoe)" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500 text-white">
                <button onclick="createNewUser(document.getElementById('new-user-username').value)" class="w-full py-3 rounded-lg bg-green-600 hover:bg-green-500 text-white font-semibold transition-colors shadow-md">
                    Create Profile
                </button>
            </div>
            
            <button onclick="closeModal('newUserModal'); showModal('loginModal')" class="mt-4 text-sm text-gray-400 hover:text-gray-200 transition-colors">
                Back to Login
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-3xl font-bold mb-4 text-white border-b border-gray-700 pb-2">User Settings</h2>
            
            <div class="space-y-6">
                <!-- Profile Information Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-300 mb-3">Profile Info</h3>
                    <div class="space-y-3">
                        <label class="block text-gray-400">Username</label>
                        <input id="setting-username" type="text" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">

                        <label class="block text-gray-400">Tag (Max 8 characters)</label>
                        <input id="setting-tag" type="text" maxlength="8" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                        
                        <label class="block text-gray-400">Profile Picture URL</label>
                        <input id="setting-pfpurl" type="text" placeholder="https://..." class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                    </div>
                </div>

                <!-- System Info Section -->
                <div class="pt-4 border-t border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300 mb-3">Account Details</h3>
                    <div class="space-y-2 text-sm">
                        <p class="text-gray-400">Your Access Code (Keep this private): <span id="setting-access-code" class="font-mono text-lg text-green-400 ml-2"></span></p>
                        <p class="text-gray-500">User ID: <span id="setting-userid" class="font-mono text-xs"></span></p>
                        <p class="text-gray-500">Admin Status: <span id="setting-admin-status" class="font-semibold text-sm"></span></p>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-between space-x-4">
                <button onclick="closeModal('settingsModal')" class="flex-1 py-3 rounded-lg bg-gray-600 hover:bg-gray-500 text-white font-semibold transition-colors">
                    Close
                </button>
                <button onclick="updateProfile()" class="flex-1 py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-semibold transition-colors shadow-md">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4 text-white">Confirm Action</h2>
            <p id="confirmation-message" class="text-gray-400 mb-6"></p>

            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('confirmationModal')" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition-colors">
                    Cancel
                </button>
                <button id="confirm-action-btn" class="py-2 px-4 rounded-lg bg-red-600 hover:bg-red-500 text-white font-semibold transition-colors">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Message Box (Non-blocking alert) -->
    <div id="message-box" class="fixed bottom-4 right-4 max-w-sm p-4 rounded-lg shadow-xl text-white opacity-0 transition-opacity duration-300 z-50 bg-blue-500">
        <h3 id="message-box-title" class="font-bold text-lg">Title</h3>
        <p id="message-box-content" class="text-sm"></p>
    </div>

    <style>
        /* Custom scrollbar for Webkit browsers */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4B5563; /* Gray-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #374151; /* Gray-700 */
        }

        /* Loading Spinner */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</div>