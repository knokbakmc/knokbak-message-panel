<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Chat Panel</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* System Font Stack: Defaults to San Francisco on macOS, Segoe UI on Windows, etc. */
        :root { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif; 
        }

        /* Style the scrollbar for better aesthetics */
        #messages-container::-webkit-scrollbar { width: 8px; }
        #messages-container::-webkit-scrollbar-thumb {
            background-color: #4b5563; /* Darker gray thumb */
            border-radius: 4px;
        }
        #messages-container::-webkit-scrollbar-track {
            background-color: #374151; /* Dark gray track */
        }
        
        /* Utility class for fade-in effect */
        .fade-in {
            opacity: 1;
            transition: opacity 1s ease-out;
        }

        /* Changelog Modal Styling */
        .changelog-modal-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-800 min-h-screen flex items-center justify-center p-4">

    <!-- 1. Code Entry Screen (Initial View) -->
    <div id="code-screen" class="w-full max-w-lg bg-gray-900 shadow-2xl rounded-xl p-8 flex flex-col items-center justify-center transition-opacity duration-500 ease-in-out">
        <h1 class="text-3xl font-bold text-white mb-6">Enter Access Code</h1>
        <p class="text-gray-400 mb-6 text-center">Please enter the security code to access the school chat panel.</p>
        
        <div id="code-box-content" class="w-full">
            <input type="text" id="access-code-input" placeholder="Ten-digit code (e.g., 5815287646)" maxlength="10" class="w-full p-4 text-center text-2xl tracking-widest border-2 border-indigo-600 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-300 bg-gray-700 text-white mb-4">
            <button id="enter-code-button" class="w-full bg-indigo-600 text-white p-4 rounded-xl font-semibold hover:bg-indigo-500 transition duration-300 shadow-lg">
                Access Chat
            </button>
            <p id="code-error" class="text-red-400 mt-4 text-center opacity-0 transition-opacity duration-300">Invalid code. Please try again.</p>
        </div>
    </div>
<!-- 2. Main Chat Container (Hidden by Default) -->
    <div id="chat-panel" class="bg-gray-900 shadow-2xl rounded-xl w-full max-w-4xl flex-col h-[90vh] transition-all duration-300 hidden opacity-0 relative">
        
        <!-- Changelog Modal Background (Hidden by Default) -->
        <div id="changelog-modal-bg" class="changelog-modal-background">
            <div id="changelog-modal" class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-2xl h-[80%] flex flex-col">
                <div class="flex justify-between items-center border-b border-gray-700 pb-4 mb-4">
                    <h2 class="text-3xl font-bold text-indigo-400">Application Changelog</h2>
                    <button id="close-changelog-button" class="text-gray-400 hover:text-white transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div id="changelog-content" class="overflow-y-auto text-gray-300 space-y-6 flex-grow p-2">
                    <!-- Changelog Content goes here -->
                    <div class="border-l-4 border-indigo-500 pl-4">
                        <h3 class="text-xl font-semibold text-white mb-1">Version 1.4.0 (Today)</h3>
                        <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
                            <li>üîî **New Feature:** Added Desktop Notifications when the window is not in focus.</li>
                            <li>‚¨ÜÔ∏è **Update:** File upload button moved directly next to the message box.</li>
                            <li>üìÇ **Feature:** Attachment links/embeds display in chat.</li>
                        </ul>
                    </div>
                    <div class="border-l-4 border-gray-600 pl-4">
                        <h3 class="text-xl font-semibold text-white mb-1">Version 1.3.0 (Recent)</h3>
                        <ul class="list-disc list-inside space-y-1 ml-4 text-sm">
                            <li>‚ú® **New Feature:** Added this Changelog view.</li>
                            <li>üõ†Ô∏è **Fix:** Implemented custom Firebase Configuration for non-Canvas environments.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header class="p-4 border-b border-gray-700 bg-indigo-700 text-white rounded-t-xl flex justify-between items-center">
            <h1 class="text-2xl font-bold">Real-Time School Chat</h1>
            <div class="flex space-x-2">
                 <!-- Changelog Button with Notification Badge -->
                <button id="changelog-toggle" class="bg-indigo-600 hover:bg-indigo-500 p-2 rounded-lg transition duration-150 shadow-md flex items-center gap-2 text-sm relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                    Changelog
                    <span id="new-message-indicator" class="hidden absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full ring-2 ring-indigo-700">0</span>
                </button>

                <button id="config-toggle" class="bg-indigo-600 hover:bg-indigo-500 p-2 rounded-lg transition duration-150 shadow-md flex items-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.525.323 1.048.513 1.58.514z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Config
                </button>
            </div>
        </header>

        <!-- Configuration Modal/Panel (Pre-filled and dark themed) -->
        <div id="config-panel" class="p-4 border-b border-gray-700 bg-yellow-900 hidden">
            <h2 class="text-lg font-semibold mb-2 text-yellow-300">Discord Webhook Configuration</h2>
            <p class="text-sm text-yellow-400 mb-3">This URL determines where external messages (e.g., administrator alerts) are sent. Note: This URL is only saved for your current session.</p>
            <div class="flex space-x-2">
                <input type="url" id="webhook-url-input" placeholder="Enter Discord Webhook URL" class="flex-grow p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-yellow-500 focus:border-yellow-500" value="https://discord.com/api/webhooks/1436501315340603444/dBximNVW0hE5I2AACU3lfrbYhEWrSmpU8bP9cY-2TI83sw-u1GQxsElup0Iw7LmC2WX-">
                <button id="save-webhook-button" class="bg-yellow-600 text-white p-2 rounded-lg font-semibold hover:bg-yellow-500 transition duration-200">Save URL</button>
            </div>
            <p id="webhook-status" class="mt-2 text-sm font-medium"></p>
        </div>

        <!-- Messages Display Area -->
        <div id="messages-container" class="flex-grow overflow-y-auto p-4 space-y-4 flex flex-col">
            <!-- Messages will be injected here by JavaScript -->
            <p id="loading-status" class="text-center text-gray-500 p-4 font-semibold">Authenticating and loading chat history...</p>
        </div>

        <!-- Message Input Area (Restructured) -->
        <div class="p-4 border-t border-gray-700 flex flex-col space-y-3">
            <input type="text" id="sender-name" placeholder="Your Display Name (e.g., JaneDoe123)" value="Student-User" class="w-full p-2 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500">
            
            <div class="flex space-x-2 items-end">
                <!-- File Selection Button (Now in main row) -->
                <input type="file" id="file-input" class="hidden" accept="image/*,video/*,application/pdf">
                <button id="select-file-button" class="bg-gray-700 text-white p-3 rounded-xl font-semibold hover:bg-gray-600 transition duration-200 flex items-center justify-center min-w-[48px] min-h-[48px]">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                </button>

                <textarea id="message-input" rows="1" placeholder="Type your message..." class="flex-grow p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 resize-none overflow-hidden border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 min-h-[48px]" style="max-height: 200px;"></textarea>
                <button id="send-button" class="bg-indigo-600 text-white p-3 rounded-xl font-semibold hover:bg-indigo-500 transition duration-200 flex items-center justify-center min-w-[48px] min-h-[48px]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
            
            <!-- Progress Bar and File Status (outside of the main input row) -->
            <div id="file-status-and-progress" class="flex flex-col space-y-2 hidden">
                <!-- File Name and Clear Button -->
                <span id="file-status" class="text-gray-400 text-sm p-3 rounded-xl bg-gray-700 flex items-center justify-between">
                    <span id="file-name-display" class="truncate"></span>
                    <button id="clear-file-button" class="text-red-400 hover:text-red-300 ml-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </span>
                 <!-- Progress Bar (Hidden by Default) -->
                <div id="upload-progress-bar" class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="progress-bar-fill" class="bg-green-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, query, onSnapshot, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// =================================
// 1. CONFIGURATION (EDIT ME)
// =================================

// --- Access Codes (10 digits) ---
const ACCESS_CODES = [
"2879556054", // David
"0009029674", // Camden
"5815287646", // Garrett
"0269927548", // Isaac
"7950368985", // Amir
];

// --- Placeholder Firebase Config (Fallback for External Hosting) ---
const PLACEHOLDER_FIREBASE_CONFIG = {
apiKey: "AIzaSyCDu1T73_HOaxC5gtHTNHev8HIfPSwbsqc",
authDomain: "knokbak-message-panel.firebaseapp.com",
projectId: "knokbak-message-panel",
storageBucket: "knokbak-message-panel.firebasestorage.app",
messagingSenderId: "424259711684",
appId: "1:424259711684:web:6818525d64024815604f91"
};
const PLACEHOLDER_APP_ID = 'knokbak-message-panel';

// --- NEW: File Upload Configuration ---
const MAX_FILE_SIZE_MB = 500;
// !!! LIVE UPLOAD ENDPOINT URL !!!
// This is the URL of your Cloudflare Worker or API endpoint.
const UPLOAD_ENDPOINT = "https://school-upload-worker-endpoint.garrett23-main-garrettlol.workers.dev";
// The secret token used for Worker authentication.
const UPLOAD_AUTH_TOKEN = "Sch00lUpl0ad2025";
// Base URL for the public file link (Used here only for context, actual URL comes from Worker response)
const CDN_BASE_URL = "https://cdna.knokbak.com/software/share/";
// =================================


// 2. GLOBAL VARIABLES
let app, db, auth, userId = null;
let currentAppId = PLACEHOLDER_APP_ID; // Initialize with fallback
let attachedFile = null; // Stores the file object selected by the user
let uploadedFileUrl = null; // Stores the URL returned after a successful upload
let webhookUrl = "https://discord.com/api/webhooks/1436501315340603444/dBximNVW0hE5I2AACU3lfrbYhEWrSmpU8bP9cY-2TI83sw-u1GQxsElup0Iw7LmC2WX-"; // Default/initial value from HTML

// Changelog/Notification Variables
let isChangelogOpen = false;
let newMessageCount = 0;
let lastChangelogCheck = Date.now();
let lastMessageTimestamp = 0;


// 3. ELEMENT REFERENCES (Defined here for scope access)
const messagesContainer = document.getElementById('messages-container');
const loadingStatus = document.getElementById('loading-status');
const codeScreen = document.getElementById('code-screen');
const chatPanel = document.getElementById('chat-panel');
const accessCodeInput = document.getElementById('access-code-input');
const codeError = document.getElementById('code-error');
const enterCodeButton = document.getElementById('enter-code-button');
const changelogToggle = document.getElementById('changelog-toggle');
const changelogModalBg = document.getElementById('changelog-modal-bg');
const closeChangelogButton = document.getElementById('close-changelog-button');
const configToggle = document.getElementById('config-toggle');
const configPanel = document.getElementById('config-panel');
const webhookUrlInput = document.getElementById('webhook-url-input');
const saveWebhookButton = document.getElementById('save-webhook-button');
const webhookStatus = document.getElementById('webhook-status');
const fileInput = document.getElementById('file-input');
const selectFileButton = document.getElementById('select-file-button');
const clearFileButton = document.getElementById('clear-file-button');
const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');
const senderNameInput = document.getElementById('sender-name');
const fileNameDisplay = document.getElementById('file-name-display');
const fileStatusAndProgress = document.getElementById('file-status-and-progress');
const uploadProgressBar = document.getElementById('upload-progress-bar');
const progressBarFill = document.getElementById('progress-bar-fill');
const newMsgIndicator = document.getElementById('new-message-indicator');
const webhookStatusElement = document.getElementById('webhook-status');
const modalMessageCount = document.getElementById('modal-message-count');


// 4. UTILITY FUNCTIONS
function formatTimestamp(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function debounce(func, delay) {
    let timeout;
    return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    };
}

function showMessage(message, isError = false) {
    codeError.textContent = message;
    codeError.classList.remove('text-red-400', 'text-green-400', 'opacity-0');
    codeError.classList.add(isError ? 'text-red-400' : 'text-green-400', 'opacity-100');
    // Hide after 5 seconds if not an error
    if (!isError) {
        setTimeout(() => {
            codeError.classList.add('opacity-0');
        }, 5000);
    }
}

function showWebhookStatus(message, isError = false) {
    webhookStatusElement.textContent = message;
    webhookStatusElement.className = `mt-2 text-sm font-medium ${isError ? 'text-red-400' : 'text-green-400'}`;
}

/**
 * Updates the status message in the file input area.
 */
function updateFileStatus(message, isError = false) {
    fileNameDisplay.textContent = message;
    fileNameDisplay.className = isError ? 'text-red-400' : 'text-green-400';
}

// 5. APPLICATION LOGIC
// Update the notification badge on the changelog button
function updateNotificationBadge() {
    modalMessageCount.textContent = newMessageCount;
    if (newMessageCount > 0) {
        newMsgIndicator.textContent = newMessageCount;
        newMsgIndicator.classList.remove('hidden');
    } else {
        newMsgIndicator.classList.add('hidden');
    }
}

// Send a desktop notification
function sendBrowserNotification(senderName, message) {
    if (!document.hidden || !("Notification" in window)) return;
    
    // Request permission if not granted
    if (Notification.permission === "default") {
        Notification.requestPermission();
        return;
    }
    
    if (Notification.permission === "granted") {
        new Notification(`${senderName} sent a message:`, {
            body: message.substring(0, 50) + (message.length > 50 ? '...' : ''),
            icon: 'https://placehold.co/100x100/4f46e5/ffffff?text=SC', // Icon for the school chat
        });
    }
}


// Initialize Firebase
async function initializeFirebase() {
    let config = PLACEHOLDER_FIREBASE_CONFIG;
    let appId = PLACEHOLDER_APP_ID;

    // Check for global config from Canvas (higher priority)
    if (typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0) {
        config = JSON.parse(__firebase_config);
    }
    if (typeof __app_id !== 'undefined') {
        appId = __app_id;
    }

    currentAppId = appId;
    
    try {
        app = initializeApp(config);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // setLogLevel('debug'); // Uncomment for debugging
        
        // Handle custom auth token if available (e.g., from Canvas)
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
            userId = user ? user.uid : crypto.randomUUID();
            console.log("Authenticated User ID:", userId);
        });
        
        return true;
    } catch (e) {
        console.error("Firebase initialization failed:", e);
        showMessage("Firebase connection error. Check console.", true);
        return false;
    }
}

// Check access code validity and log the user in
async function validateCode(code) {
    const codeInput = code.toUpperCase().trim();
    if (codeInput.length !== 10) {
        showMessage("Code must be 10 characters long.", true);
        return;
    }
    
    if (!db) {
        showMessage("Database not connected. Please wait.", true);
        return;
    }

    // --- Access Code Logic ---
    // In a real scenario, this would check a Firestore/DB collection.
    // For this demonstration, we are validating against a hardcoded list.
    const validNames = {
        "2879556054": "David",
        "0009029674": "Camden",
        "5815287646": "Garrett",
        "0269927548": "Isaac",
        "7950368985": "Amir",
        "STUDENT123": "Student-User" // Fallback name
    };
    
    const isValid = ACCESS_CODES.includes(codeInput) || Object.keys(validNames).includes(codeInput);

    if (isValid) {
        const userName = validNames[codeInput] || 'Authenticated User';
        
        senderNameInput.value = userName; // Set the display name input
        
        codeScreen.classList.add('hidden');
        chatPanel.classList.remove('hidden', 'opacity-0');
        chatPanel.classList.add('opacity-100');
        
        // Start listening to the chat after successful validation
        listenForMessages();

    } else {
        showMessage("Invalid code. Access denied.", true);
    }
}


// --- File Upload Handling ---

selectFileButton.addEventListener('click', () => fileInput.click());
clearFileButton.addEventListener('click', clearAttachedFile);

fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) {
        clearAttachedFile();
        return;
    }

    // Check file size limit
    if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
        showMessage(`File size exceeds the ${MAX_FILE_SIZE_MB}MB limit.`, true);
        clearAttachedFile();
        return;
    }

    attachedFile = file;
    fileNameDisplay.textContent = file.name;
    fileStatusAndProgress.classList.remove('hidden');
    showMessage(`File selected: ${file.name}`);
});

function clearAttachedFile() {
    attachedFile = null;
    uploadedFileUrl = null;
    fileInput.value = '';
    fileStatusAndProgress.classList.add('hidden');
    progressBarFill.style.width = '0%';
    // Reset status display
    fileNameDisplay.className = 'text-sm text-gray-300 font-medium truncate mb-1';
    fileNameDisplay.textContent = '';
}

/**
 * Uploads the attached file to the Cloudflare Worker endpoint.
 */
async function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    // START: Loading/Progress State
    fileStatusAndProgress.classList.remove('hidden');
    uploadProgressBar.classList.remove('hidden');
    progressBarFill.style.width = '50%'; // Indicate indeterminate progress
    updateFileStatus(`Uploading ${file.name}...`);
    
    // üõë DEBUGGING STEP: Log the endpoint and token üõë
    console.log(`[UPLOAD DEBUG] Attempting POST to: ${UPLOAD_ENDPOINT} with token: ${UPLOAD_AUTH_TOKEN}`);
    
    try {
        const response = await fetch(UPLOAD_ENDPOINT, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Upload-Auth': UPLOAD_AUTH_TOKEN
            }
        });

        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(`Upload failed (${response.status} - ${response.statusText}): ${errorData}`);
        }

        const result = await response.json();
        
        // Finalize progress bar and button state
        progressBarFill.style.width = '100%';
        updateFileStatus(`Upload Complete: ${file.name}`, false);
        
        // Wait a moment before allowing the UI to clear the progress bar
        setTimeout(() => {
            uploadProgressBar.classList.add('hidden');
            fileStatusAndProgress.classList.add('hidden'); // Fully hide the file status area
        }, 1500);

        return result.url; 

    } catch (error) {
        // Reset state on failure
        uploadProgressBar.classList.add('hidden'); // Hide bar
        progressBarFill.style.width = '0%';
        
        // Check if it's the specific "Failed to fetch" error
        if (error.message.includes("Failed to fetch")) {
            updateFileStatus(`Error: Failed to fetch (Network/CORS issue). Check your UPLOAD_ENDPOINT URL and Worker status.`, true);
        } else {
            updateFileStatus(`Error: ${error.message}`, true);
        }
        
        console.error("[UPLOAD ERROR]", error);
        
        // Clear file data on upload failure so user can retry or send text only
        attachedFile = null; 
        uploadedFileUrl = null;
        fileInput.value = '';
        
        throw error; // Re-throw to be caught in sendMessage
    }
}

// --- Chat Messaging Logic ---

// Sends the message to Firestore and Discord
async function sendMessage() {
    console.log("--- sendMessage called ---");
    if (!db) {
        showMessage("Chat service not connected. Please refresh.", true);
        return;
    }

    const messageText = messageInput.value.trim();
    const senderName = senderNameInput.value.trim() || 'Anonymous';
    
    console.log(`Text: "${messageText}", File Attached: ${!!attachedFile}`);

    // Prevent sending empty message AND no attached file
    if (messageText === "" && !attachedFile) {
        showMessage("Please enter a message or select a file.", true);
        console.log("sendMessage exiting: Empty content.");
        return;
    }
    
    // Temporarily disable send button immediately
    sendButton.disabled = true;

    // If a file is attached, upload it first
    if (attachedFile && !uploadedFileUrl) {
        try {
            // This is where the upload happens, and it updates the UI via uploadFile
            uploadedFileUrl = await uploadFile(attachedFile);
        } catch (e) {
            console.error("File upload failed in sendMessage:", e);
            // uploadFile already handles UI cleanup on error, just re-enable the button
            sendButton.disabled = false;
            return; // Exit as upload failed
        }
    }
    
    // Safety check: if they only attached a file, but the upload failed, we exit.
    if (messageText === "" && !uploadedFileUrl) {
         showMessage("Upload failed or URL is missing. Please try again.", true);
         sendButton.disabled = false;
         return;
    }


    // Public data path uses the dynamically determined currentAppId
    const messagesCollectionPath = `/artifacts/${currentAppId}/public/data/messages`;
    const messagesRef = collection(db, messagesCollectionPath);
    
    // START DB/Webhook sending
    updateFileStatus(attachedFile ? `Sending message and link...` : `Sending message...`);

    try {
        // 1. Save to Firestore
        await setDoc(doc(messagesRef), {
            text: messageText,
            timestamp: serverTimestamp(),
            senderName: senderName,
            senderId: userId,
            attachmentUrl: uploadedFileUrl
        });
        
        // 2. Post to Discord (webhook) - Non-blocking
        postToDiscord(messageText, senderName, uploadedFileUrl);

        // 3. Cleanup
        messageInput.value = '';
        messageInput.style.height = 'auto';
        messageInput.focus();
        clearAttachedFile(); // Clears file variables and UI elements
        showMessage(`Message sent successfully.`, false);
        
        // Final button re-enable
        sendButton.disabled = false;


    } catch (e) {
        console.error("Error sending message to Firestore:", e);
        showMessage('Failed to send message: ' + e.message, true);
        updateFileStatus(`Failed to save message: ${e.message}`, true);
        sendButton.disabled = false;
    }
}

sendButton.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // Prevents newline
        sendMessage();
    }
});

// Auto-resize textarea
messageInput.addEventListener('input', () => {
    messageInput.style.height = 'auto';
    messageInput.style.height = messageInput.scrollHeight + 'px';
});

// Creates a media embed/link based on file type
function createAttachmentHTML(url) {
    if (!url) return '';

    const fileExtension = url.split('.').pop().toLowerCase();
    let mediaHTML = '';

    // Check for common media types for embedding - INCLUDES 'gif'
    if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExtension)) {
        // Image embed
        mediaHTML = `<img src="${url}" class="max-w-full h-auto rounded-lg mt-2 cursor-pointer" onerror="this.outerHTML='<p class=\\'text-red-400\\'>Failed to load image. <a href=\\'${url}\\' target=\\'_blank\\' class=\\'underline\\'>View Link</a></p>'" onclick="window.open('${url}', '_blank')" />`;
    } else if (['mp4', 'webm'].includes(fileExtension)) {
        // Video embed
        mediaHTML = `<video src="${url}" controls class="max-w-full h-auto rounded-lg mt-2"></video>`;
    } else {
        // General file link (like Discord)
        mediaHTML = `<a href="${url}" target="_blank" class="text-blue-400 hover:text-blue-300 underline block mt-2 break-words">üìé Attachment: ${url.split('/').pop()}</a>`;
    }

    return `<div class="bg-gray-800 p-2 rounded-lg border border-gray-700 mt-2">${mediaHTML}</div>`;
}


// Creates a message bubble HTML element
function createMessageElement(data) {
    const isSelf = data.senderId === userId;
    const time = formatTimestamp(data.timestamp);
    const attachmentHTML = createAttachmentHTML(data.attachmentUrl);

    const alignment = isSelf ? 'self-end' : 'self-start';
    const bgColor = isSelf ? 'bg-indigo-600 text-white' : 'bg-gray-700 text-gray-100';
    const displayName = data.senderName;
    const nameColor = isSelf ? 'text-indigo-200' : 'text-gray-400';

    const div = document.createElement('div');
    div.className = `max-w-xs md:max-w-md p-3 rounded-xl shadow-md ${bgColor} ${alignment}`;
    div.innerHTML = `
    <div class="text-sm font-bold mb-1 ${nameColor}">${displayName}</div>
    <div class="text-base whitespace-pre-wrap break-words">${data.text || ''}</div>
    ${attachmentHTML}
    <div class="text-xs mt-1 text-opacity-80 text-right ${isSelf ? 'text-indigo-200' : 'text-gray-400'}">${time}</div>
    `;
    return div;
}

// Listens for real-time messages from Firestore
function listenForMessages() {
    // Public data path uses the dynamically determined currentAppId
    const messagesCollectionPath = `/artifacts/${currentAppId}/public/data/messages`;
    const messagesQuery = query(collection(db, messagesCollectionPath), orderBy('timestamp'));

    // Remove the loading status text once listening starts
    if (loadingStatus) {
        loadingStatus.remove();
    }

    // Set up real-time listener
    onSnapshot(messagesQuery, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            const data = { id: change.doc.id, ...change.doc.data() };

            if (change.type === "added") {
                const newElement = createMessageElement(data);
                messagesContainer.appendChild(newElement);

                // Check if the message is NOT from the current user
                if (data.senderId !== userId) {
                    // 1. Send Desktop Notification if window is hidden
                    sendBrowserNotification(data.senderName, data.text);

                    // 2. Handle Changelog badge update
                    if (!isChangelogOpen) {
                        newMessageCount++;
                        updateNotificationBadge();
                    }
                }

                // Scroll to bottom only if changelog is NOT open
                if (!isChangelogOpen) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }
        });
    }, (error) => {
        console.error("Error listening to messages:", error);
        messagesContainer.innerHTML = `<p class="text-red-500 p-4">Failed to load chat history.</p>`;
    });
}

// Toggle Changelog Modal
changelogToggle.addEventListener('click', () => {
    isChangelogOpen = true;
    changelogModalBg.style.display = 'flex';
    // Clear notification badge when changelog is opened
    newMessageCount = 0;
    updateNotificationBadge();
});

closeChangelogButton.addEventListener('click', () => {
    isChangelogOpen = false;
    changelogModalBg.style.display = 'none';
});

// Discord Webhook configuration logic
saveWebhookButton.addEventListener('click', () => {
    const url = webhookUrlInput.value.trim();
    if (!url || !url.includes("discord.com/api/webhooks")) {
        showWebhookStatus("Invalid URL. Must be a Discord webhook link.", true);
        return;
    }

    webhookUrl = url;
    webhookUrlInput.value = url;
    showWebhookStatus("Webhook URL updated in session only.", false);
    showMessage("Webhook updated for this session!");
});

// Posts the message to the saved Discord webhook
async function postToDiscord(message, senderName, attachmentUrl = null) {
    if (!webhookUrl || !webhookUrl.includes("discord.com/api/webhooks")) {
        console.error("Webhook not configured or invalid.");
        return;
    }

    const payload = {
        content: message,
        username: senderName,
        avatar_url: "https://placehold.co/100x100/4f46e5/ffffff?text=SC"
    };

    if (attachmentUrl) {
        payload.content = payload.content.trim() + (payload.content.trim() ? '\n\n' : '') + attachmentUrl;
    }

    try {
        await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
    } catch (e) {
        console.error("Network Error posting to Discord:", e);
    }
}

// Toggle Configuration Panel
configToggle.addEventListener('click', () => {
    configPanel.classList.toggle('hidden');
});


// Initialization
document.addEventListener('DOMContentLoaded', async () => {
    // Initial check for notification permission
    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
    }
    
    // Check for Canvas environment configuration and initialize Firebase
    if (await initializeFirebase()) {
        enterCodeButton.addEventListener('click', () => validateCode(accessCodeInput.value));
        accessCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') validateCode(accessCodeInput.value);
        });
    } else {
        // Fallback for failed initialization
        codeScreen.innerHTML = '<h1 class="text-3xl font-bold text-red-500">Initialization Error</h1><p class="text-gray-400 mt-4 text-center">Could not connect to Firebase. Check your configuration and network.</p>';
    }
});
</script>