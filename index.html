<div class="min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center p-4">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- HARDCODED DEFAULT FIREBASE CONFIG ---
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyCDu1T73_HOaxC5gtHTNHev8HIfPSwbsqc", 
            authDomain: "knokbak-message-panel.firebaseapp.com",
            projectId: "knokbak-message-panel",
            storageBucket: "knokbak-message-panel.firebasestorage.app",
            messagingSenderId: "424259711684",
            appId: "1:424259711684:web:6818525d64024815604f91"
        };
        
        // Global Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // **Firebase Config setup**
        let firebaseConfig;
        try {
            const envConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            const parsedConfig = JSON.parse(envConfig);
            firebaseConfig = (parsedConfig && parsedConfig.apiKey) ? parsedConfig : defaultFirebaseConfig;
        } catch (e) {
            console.warn("Could not parse environment Firebase config. Using default config.");
            firebaseConfig = defaultFirebaseConfig;
        }

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let currentUserData = null; // Stores user profile data
        let currentServerId = 'global'; 
        let unsubscribeMessages = null;
        let unsubscribeUsers = null;
        let isAdmin = false;
        let isAuthReady = false;

        const ADMIN_ID = "5815287646"; 
        const MESSAGES_COLLECTION_PATH = `/artifacts/${appId}/public/data/messages`;
        const USERS_COLLECTION_PATH = `/artifacts/${appId}/public/data/users`;
        // Since we are not using access codes anymore, we define a collection path for simple users
        const ANONYMOUS_USERS_COLLECTION_PATH = `/artifacts/${appId}/public/data/anonymous_users`; 
        
        // --- Utility Functions ---

        // Simple debounce function to limit function calls
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // --- Auth and Init (Simplified) ---

        async function initFirebase() {
            try {
                setLogLevel('error'); 
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await setPersistence(auth, browserSessionPersistence);
                
                // Immediately sign in anonymously for instant access
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }

                // Wait for auth state to be resolved
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        currentUserId = user.uid;
                        // For the simplified version, the anonymous UID is the user ID.
                        handleSuccessfulAuth(); 
                    } else {
                        currentUserId = null;
                        document.getElementById('loading-status').textContent = "Authentication Failed. Cannot access Firestore.";
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loading-status').textContent = `Initialization Error: ${error.message}`;
                showMessageBox("Error", `Firebase init failed: ${error.message}`, 5000, 'bg-red-500');
            }
        }

        async function createOrFetchAnonymousUserProfile() {
            if (!currentUserId || !db) return;

            const userDocRef = doc(db, ANONYMOUS_USERS_COLLECTION_PATH, currentUserId);
            const docSnap = await getDoc(userDocRef);
            
            if (docSnap.exists()) {
                currentUserData = docSnap.data();
                isAdmin = currentUserData.isAdmin || false;
            } else {
                // If it's a new anonymous user, create a default profile
                const randomName = `User${Math.floor(1000 + Math.random() * 9000)}`;
                const newProfile = {
                    userId: currentUserId,
                    username: randomName,
                    tag: Math.floor(1000 + Math.random() * 9000).toString(),
                    pfpUrl: `https://placehold.co/80x80/${Math.floor(Math.random()*16777215).toString(16)}/ffffff?text=${randomName.charAt(0)}`,
                    isAdmin: currentUserId === ADMIN_ID,
                    lastOnline: serverTimestamp(),
                    isAnonymous: true
                };
                await setDoc(userDocRef, newProfile);
                currentUserData = newProfile;
                isAdmin = newProfile.isAdmin;
            }
            // Update last online timestamp every time we load
            await updateDoc(userDocRef, { lastOnline: serverTimestamp() });
        }

        async function handleSuccessfulAuth() {
            if (!currentUserId) {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('app-container').classList.add('hidden');
                return;
            }

            // 1. Fetch or create the user's profile
            await createOrFetchAnonymousUserProfile();
            
            if (currentUserData) {
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('loading-overlay').classList.add('hidden');
                setupListeners();
                updateProfileDisplay();
            } else {
                 document.getElementById('loading-status').textContent = "Profile data still loading...";
            }
        }
        
        // --- Firestore Listeners ---

        function setupListeners() {
            // Stop existing listeners first
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeUsers) unsubscribeUsers();
            
            // Check for auth readiness before querying
            if (!isAuthReady || !currentUserId) {
                console.warn("Attempted to set up listeners before auth was ready.");
                return;
            }

            // 1. Messages Listener
            const messagesRef = collection(db, MESSAGES_COLLECTION_PATH);
            const messagesQuery = query(messagesRef, where('serverId', '==', currentServerId));

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    messages.push({ ...data, id: doc.id, timestamp: data.timestamp ? data.timestamp.toDate() : new Date() });
                });
                // Sort messages by timestamp
                messages.sort((a, b) => a.timestamp - b.timestamp);
                renderMessages(messages);
            }, (error) => {
                // If this is the source of the insufficient permissions error, it will log here.
                console.error("Error fetching messages (Permissions Issue):", error);
                showMessageBox("Permissions Error", "Could not fetch messages. Check environment rules.", 5000, 'bg-red-700');
            });

            // 2. Users Listener
            const usersRef = collection(db, ANONYMOUS_USERS_COLLECTION_PATH);
            
            unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
                const users = [];
                snapshot.forEach(doc => {
                    users.push({ ...doc.data(), id: doc.id });
                });
                renderUserList(users);
            }, (error) => {
                console.error("Error fetching users:", error);
            });
            
             // 3. User Presence/Online Status (Debounced Update)
             const updateOnlineStatus = debounce(async (isOnline) => {
                if (currentUserId && db && currentUserData) {
                    try {
                        await updateDoc(doc(db, ANONYMOUS_USERS_COLLECTION_PATH, currentUserId), {
                            lastOnline: isOnline ? serverTimestamp() : Date.now(),
                            isOnline: isOnline 
                        });
                    } catch (e) {
                        console.error("Failed to update presence:", e);
                    }
                }
            }, 1000); // 1-second debounce

            // Update status on load/active
            updateOnlineStatus(true);
            
            // Add global event listeners for presence tracking
            window.addEventListener('focus', () => updateOnlineStatus(true));
            window.addEventListener('blur', () => updateOnlineStatus(false));
            window.addEventListener('beforeunload', () => updateOnlineStatus(false));
        }

        // --- Message Handling ---

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            if (!content || !currentUserId || !currentUserData) {
                if (!currentUserData) showMessageBox("Error", "Profile still loading. Please wait.", 3000, 'bg-red-500');
                return;
            }

            const message = {
                userId: currentUserId,
                username: currentUserData.username,
                tag: currentUserData.tag,
                content: content,
                pfpUrl: currentUserData.pfpUrl,
                serverId: currentServerId, // Currently 'global'
                timestamp: serverTimestamp()
            };

            try {
                // Note: This collection must be publicly writable by authenticated users
                await addDoc(collection(db, MESSAGES_COLLECTION_PATH), message);
                input.value = ''; // Clear input on success
            } catch (error) {
                console.error("Error sending message (Permissions Issue):", error);
                showMessageBox("Permissions Error", "Failed to send message. Check console.", 5000, 'bg-red-700');
            }
        }

        function renderMessages(messages) {
            const chatBox = document.getElementById('chat-box');
            let wasScrolledToBottom = chatBox.scrollHeight - chatBox.clientHeight <= chatBox.scrollTop + 1;

            chatBox.innerHTML = ''; // Clear previous messages

            messages.forEach(msg => {
                const isMine = msg.userId === currentUserId;
                const messageHtml = `
                    <div class="flex items-start space-x-3 p-2 hover:bg-gray-800 transition-colors">
                        <img src="${msg.pfpUrl}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/6B7280/ffffff?text=U'" class="w-10 h-10 rounded-full flex-shrink-0">
                        <div class="flex flex-col w-full">
                            <div class="flex items-baseline space-x-2">
                                <span class="text-sm font-semibold ${isMine ? 'text-green-400' : 'text-blue-400'}">${msg.username}</span>
                                <span class="text-xs text-gray-500">#${msg.tag}</span>
                                <span class="text-xs text-gray-500">${msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : '...'}</span>
                                ${isAdmin && !msg.isAdmin ? `<button onclick="window.deleteMessage('${msg.id}')" class="text-red-500 hover:text-red-400 text-xs ml-auto">Delete</button>` : ''}
                            </div>
                            <p class="text-sm text-gray-300 break-words whitespace-pre-wrap">${escapeHTML(msg.content)}</p>
                        </div>
                    </div>
                `;
                chatBox.insertAdjacentHTML('beforeend', messageHtml);
            });

            // Scroll to bottom only if the user was already near the bottom
            if (wasScrolledToBottom) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
        
        // Expose deleteMessage function globally for inline click handler
        window.deleteMessage = async function(messageId) {
            if (!isAdmin || !messageId) {
                 showMessageBox("Permission Denied", "Only administrators can delete messages.", 3000, 'bg-red-500');
                 return;
            }
            
            showModal('confirmationModal', 'Are you sure you want to delete this message?', () => confirmDelete(messageId));
        }
        
        async function confirmDelete(messageId) {
            closeModal('confirmationModal');
            try {
                await deleteDoc(doc(db, MESSAGES_COLLECTION_PATH, messageId));
                showMessageBox("Success", "Message deleted.", 2000, 'bg-green-600');
            } catch (error) {
                console.error("Error deleting message:", error);
                showMessageBox("Error", "Failed to delete message.", 3000, 'bg-red-500');
            }
        }
        
        // --- User List and Profile UI ---

        function renderUserList(users) {
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            
            // Separate online and offline users
            const now = Date.now();
            // A user is considered online if they updated their timestamp in the last 30 seconds
            const onlineUsers = users.filter(u => u.isOnline === true || (u.lastOnline && (now - (u.lastOnline.toMillis ? u.lastOnline.toMillis() : u.lastOnline)) < 30000));
            const offlineUsers = users.filter(u => !u.isOnline && (u.lastOnline && (now - (u.lastOnline.toMillis ? u.lastOnline.toMillis() : u.lastOnline)) >= 30000));

            // Sort by username
            onlineUsers.sort((a, b) => a.username.localeCompare(b.username));
            offlineUsers.sort((a, b) => a.username.localeCompare(b.username));
            
            const renderUser = (user, isOnline) => {
                 const statusColor = isOnline ? 'bg-green-500' : 'bg-gray-500';
                 const statusText = isOnline ? 'Online' : 'Offline';
                 const isSelf = user.userId === currentUserId;
                 const adminBadge = user.isAdmin ? '<span class="text-xs font-bold text-red-400">ADMIN</span>' : '';
                 
                 return `
                    <div class="flex items-center p-2 rounded-lg hover:bg-gray-700 transition-colors ${isSelf ? 'bg-gray-700' : ''}">
                        <div class="relative mr-3">
                            <img src="${user.pfpUrl}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/6B7280/ffffff?text=U'" class="w-8 h-8 rounded-full">
                            <span class="absolute bottom-0 right-0 w-2.5 h-2.5 ${statusColor} rounded-full border-2 border-gray-800" title="${statusText}"></span>
                        </div>
                        <div class="flex flex-col min-w-0">
                            <div class="flex items-center space-x-1 min-w-0">
                                <span class="text-sm font-medium text-gray-200 truncate">${user.username}</span>
                                ${adminBadge}
                            </div>
                            <span class="text-xs text-gray-500">#${user.tag}</span>
                        </div>
                    </div>
                 `;
            };

            const appendGroup = (title, list, isOnline) => {
                if (list.length > 0) {
                     userList.insertAdjacentHTML('beforeend', `<h3 class="text-xs font-semibold text-gray-400 uppercase mt-4 mb-2 px-2">${title} - ${list.length}</h3>`);
                     list.forEach(user => userList.insertAdjacentHTML('beforeend', renderUser(user, isOnline)));
                }
            };
            
            appendGroup('Online', onlineUsers, true);
            appendGroup('Offline', offlineUsers, false);

            document.getElementById('user-count').textContent = users.length;
        }

        function updateProfileDisplay() {
            if (!currentUserData) return;
            const profileDisplay = document.getElementById('profile-display');
            
            profileDisplay.innerHTML = `
                <div class="flex items-center space-x-3">
                    <img src="${currentUserData.pfpUrl}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/6B7280/ffffff?text=U'" class="w-10 h-10 rounded-full">
                    <div class="flex flex-col min-w-0">
                        <span class="text-sm font-semibold text-white truncate">${currentUserData.username}</span>
                        <span class="text-xs text-gray-400">#${currentUserData.tag}</span>
                    </div>
                </div>
            `;
            
            // Populate settings modal inputs
            document.getElementById('setting-username').value = currentUserData.username || '';
            document.getElementById('setting-tag').value = currentUserData.tag || '';
            document.getElementById('setting-pfpurl').value = currentUserData.pfpUrl || '';
            document.getElementById('setting-userid').textContent = currentUserId || 'N/A';
            document.getElementById('setting-admin-status').textContent = isAdmin ? 'Yes' : 'No';
        }
        
        async function updateProfile() {
            if (!currentUserId || !db) return;

            const newUsername = document.getElementById('setting-username').value.trim();
            const newTag = document.getElementById('setting-tag').value.trim();
            const newPfpUrl = document.getElementById('setting-pfpurl').value.trim();

            if (!newUsername || !newTag || newTag.length > 8) {
                showMessageBox("Error", "Username cannot be empty, and Tag must be 1-8 characters.", 4000, 'bg-red-500');
                return;
            }
            
            try {
                // Update User Profile in the ANONYMOUS_USERS collection
                await updateDoc(doc(db, ANONYMOUS_USERS_COLLECTION_PATH, currentUserId), {
                    username: newUsername,
                    tag: newTag,
                    pfpUrl: newPfpUrl
                });

                // Re-fetch and update local state
                await createOrFetchAnonymousUserProfile();
                updateProfileDisplay();
                
                closeModal('settingsModal');
                showMessageBox("Success", "Profile updated successfully!", 3000, 'bg-green-600');

            } catch (error) {
                console.error("Error updating profile:", error);
                showMessageBox("Error", "Failed to update profile.", 3000, 'bg-red-500');
            }
        }
        
        // --- Modal/UI Controls ---
        
        function escapeHTML(str) {
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
        }

        function showModal(modalId, message = '', confirmAction = null) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            // Handle specific content for confirmation modal
            if (modalId === 'confirmationModal') {
                document.getElementById('confirmation-message').textContent = message;
                const confirmBtn = document.getElementById('confirm-action-btn');
                confirmBtn.onclick = () => confirmAction(); // Set the specific action
            }

            modal.classList.remove('hidden');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // --- Message Box UI (Non-blocking alerts) ---
        let messageBoxTimeout;
        function showMessageBox(title, message, duration = 3000, bgColor = 'bg-blue-500') {
            const msgBox = document.getElementById('message-box');
            const msgTitle = document.getElementById('message-box-title');
            const msgContent = document.getElementById('message-box-content');

            clearTimeout(messageBoxTimeout);

            msgBox.className = `fixed bottom-4 right-4 max-w-sm p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 z-50 ${bgColor}`;
            msgTitle.textContent = title;
            msgContent.textContent = message;
            msgBox.classList.remove('opacity-0');

            messageBoxTimeout = setTimeout(() => {
                msgBox.classList.add('opacity-0');
            }, duration);
        }
        
        // Assign global functions for HTML interaction
        window.sendMessage = sendMessage;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.updateProfile = updateProfile;
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', initFirebase);
        
        // Add event listener for the message input to allow sending with Enter key
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.id === 'message-input') {
                e.preventDefault();
                sendMessage();
            }
        });

    </script>

    <!-- Main Chat Application Container -->
    <div id="app-container" class="hidden w-full h-[90vh] max-w-6xl flex rounded-xl shadow-2xl overflow-hidden bg-gray-800">

        <!-- Sidebar (Channels and User Profile) -->
        <div class="w-20 bg-gray-900 flex flex-col items-center py-4 space-y-4">
            <!-- Server Icon -->
            <button class="w-12 h-12 bg-blue-600 hover:bg-blue-500 text-white font-bold text-lg rounded-xl flex items-center justify-center transition-all shadow-md active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                </svg>
            </button>
        </div>

        <!-- Channel List (Text Channels) -->
        <div class="w-56 bg-gray-700 flex flex-col justify-between">
            <div class="p-3">
                <h2 class="text-xl font-bold mb-4 text-white truncate">Global Chat</h2>
                <div class="space-y-1">
                    <button class="w-full text-left p-2 rounded-lg bg-gray-600 text-gray-200 font-semibold flex items-center transition-colors hover:bg-gray-500">
                        <span class="mr-2 text-lg">#</span> Global-Lounge
                    </button>
                </div>
            </div>
            
            <!-- User Profile Box -->
            <div class="p-3 bg-gray-800 border-t border-gray-700">
                <button id="profile-display" onclick="showModal('settingsModal')" class="w-full text-left p-1 rounded-lg hover:bg-gray-600 transition-colors flex items-center space-x-2">
                    <!-- Profile data populated by JS -->
                </button>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Chat Header -->
            <header class="h-14 flex items-center px-4 border-b border-gray-700 shadow-md">
                <h1 class="text-lg font-semibold text-gray-200"># Global-Lounge</h1>
            </header>

            <!-- Messages Box -->
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                <!-- Messages will be rendered here -->
            </div>

            <!-- Message Input -->
            <div class="p-4">
                <div class="flex items-center bg-gray-700 rounded-lg p-2 shadow-lg">
                    <input id="message-input" type="text" placeholder="Message #Global-Lounge" class="flex-1 bg-transparent text-gray-200 placeholder-gray-400 focus:outline-none px-2 py-1">
                    <button onclick="sendMessage()" class="ml-2 p-2 rounded-full bg-blue-600 text-white hover:bg-blue-500 transition-colors active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.149.736A1 1 0 003 18h14a1 1 0 00.899-1.488l-7-14zM6 15a1 1 0 100-2 1 1 0 000 2z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- User List (Right Sidebar) -->
        <div class="w-56 bg-gray-700 flex flex-col flex-shrink-0 border-l border-gray-700 overflow-y-auto custom-scrollbar">
            <h3 class="text-xs font-semibold text-gray-400 uppercase mt-4 mb-2 px-3">Members (<span id="user-count">0</span>)</h3>
            <div id="user-list" class="flex flex-col p-1">
                <!-- User List populated by JS -->
            </div>
        </div>

    </div>
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="flex flex-col items-center space-y-4">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <p id="loading-status" class="text-lg text-gray-400">Initializing Firebase for instant access...</p>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-3xl font-bold mb-4 text-white border-b border-gray-700 pb-2">User Settings</h2>
            
            <div class="space-y-6">
                <!-- Profile Information Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-300 mb-3">Profile Info</h3>
                    <div class="space-y-3">
                        <label class="block text-gray-400">Username</label>
                        <input id="setting-username" type="text" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">

                        <label class="block text-gray-400">Tag (Max 8 characters)</label>
                        <input id="setting-tag" type="text" maxlength="8" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                        
                        <label class="block text-gray-400">Profile Picture URL</label>
                        <input id="setting-pfpurl" type="text" placeholder="https://..." class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                    </div>
                </div>

                <!-- System Info Section -->
                <div class="pt-4 border-t border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-300 mb-3">Account Details</h3>
                    <div class="space-y-2 text-sm">
                        <p class="text-gray-400">Account Type: <span class="font-semibold text-sm text-yellow-400 ml-2">Anonymous Guest</span></p>
                        <p class="text-gray-500">User ID: <span id="setting-userid" class="font-mono text-xs"></span></p>
                        <p class="text-gray-500">Admin Status: <span id="setting-admin-status" class="font-semibold text-sm"></span></p>
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-between space-x-4">
                <button onclick="closeModal('settingsModal')" class="flex-1 py-3 rounded-lg bg-gray-600 hover:bg-gray-500 text-white font-semibold transition-colors">
                    Close
                </button>
                <button onclick="updateProfile()" class="flex-1 py-3 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-semibold transition-colors shadow-md">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4 text-white">Confirm Action</h2>
            <p id="confirmation-message" class="text-gray-400 mb-6"></p>

            <div class="flex justify-end space-x-3">
                <button onclick="closeModal('confirmationModal')" class="py-2 px-4 rounded-lg bg-gray-600 hover:bg-gray-500 text-white transition-colors">
                    Cancel
                </button>
                <button id="confirm-action-btn" class="py-2 px-4 rounded-lg bg-red-600 hover:bg-red-500 text-white font-semibold transition-colors">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Message Box (Non-blocking alert) -->
    <div id="message-box" class="fixed bottom-4 right-4 max-w-sm p-4 rounded-lg shadow-xl text-white opacity-0 transition-opacity duration-300 z-50 bg-blue-500">
        <h3 id="message-box-title" class="font-bold text-lg">Title</h3>
        <p id="message-box-content" class="text-sm"></p>
    </div>

    <style>
        /* Custom scrollbar for Webkit browsers */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4B5563; /* Gray-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #374151; /* Gray-700 */
        }

        /* Loading Spinner */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }

        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</div>