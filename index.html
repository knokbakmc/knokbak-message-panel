<div class="min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center p-4">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        .full-screen-app {
            width: 100vw;
            height: 100vh;
            max-width: none;
            max-height: none;
            display: flex;
        }

        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
            padding-right: 8px;
        }
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 4px;
        }
        .chat-container::-webkit-scrollbar-track {
            background-color: #1f2937;
        }

        /* Styling for the blurred code display */
        .code-blur {
            filter: blur(8px);
            transition: filter 0.3s;
            user-select: none;
        }
        .code-blur:hover {
            filter: blur(0);
        }
    </style>

    <!-- Main Content Area -->
    <div class="w-full max-w-7xl h-[90vh] bg-gray-800 rounded-xl shadow-2xl overflow-hidden flex" id="main-app-container">
        
        <!-- Access Code Screen (Initial State) -->
        <div id="code-screen" class="absolute inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center p-8 transition-opacity duration-500">
            <h2 class="text-3xl font-bold mb-4 text-center text-indigo-400">Welcome to School Chat</h2>
            <p class="text-gray-400 mb-6 text-center">Enter your 10-digit Access Code to begin.</p>
            <input type="text" id="access-code-input" maxlength="10" placeholder="0000000000" class="w-full max-w-sm p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 text-center text-xl tracking-wider focus:ring-indigo-500 focus:border-indigo-500 mb-4 uppercase">
            <button id="enter-code-button" class="w-full max-w-sm p-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-semibold transition duration-150">ENTER</button>
            <p id="code-error" class="mt-4 text-sm font-medium text-red-400 opacity-0 transition duration-500"></p>
            <p id="loading-status" class="mt-6 text-gray-500 text-sm">Initializing chat service...</p>
        </div>

        <!-- Left Sidebar (Servers & DMs) -->
        <div id="sidebar" class="w-20 bg-gray-900 flex flex-col items-center py-3 space-y-3 hidden">
            <!-- Server/DM Icons go here -->
            <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-xl font-bold hover:rounded-xl transition-all duration-200 cursor-pointer shadow-lg">SC</div>
            <div class="w-12 h-12 bg-gray-700 rounded-full flex items-center justify-center text-gray-300 text-xl font-bold hover:rounded-xl transition-all duration-200 cursor-pointer shadow-lg">DMs</div>

            <!-- Plus button for new server -->
            <button id="add-server-button" class="mt-4 w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white text-3xl hover:rounded-xl transition-all duration-200 shadow-lg">+</button>
        </div>
        
        <!-- Chat Panel (Main View) -->
        <div id="chat-panel" class="flex-grow flex flex-col hidden opacity-0 transition-opacity duration-500">
            
            <!-- Header (Channel Name) -->
            <header class="bg-gray-700 p-4 border-b border-gray-600 shadow-lg flex justify-between items-center">
                <h1 class="text-xl font-bold text-indigo-400"># Global Chat</h1>
                <!-- Right side header elements can go here -->
            </header>
            
            <!-- Messages Container -->
            <div id="messages-container" class="chat-container flex flex-col space-y-4 p-4 flex-grow">
                <!-- Messages will be injected here by JavaScript -->
            </div>

            <!-- Typing Indicator (Placeholder) -->
            <div id="typing-indicator" class="px-4 py-2 text-sm text-gray-500 h-8">
                <!-- User typing messages appear here -->
            </div>

            <!-- Message Input Area -->
            <div class="p-4 border-t border-gray-700 bg-gray-700 relative">
                
                <!-- File Status/Progress Display -->
                <div id="file-status-and-progress" class="mb-2 hidden">
                    <div id="file-name-display" class="text-sm text-gray-300 font-medium truncate mb-1"></div>
                    <div id="upload-progress-bar" class="w-full h-1 bg-gray-600 rounded overflow-hidden hidden">
                        <div id="progress-bar-fill" class="h-full bg-indigo-500 transition-all duration-300 ease-linear" style="width: 0%;"></div>
                    </div>
                </div>

                <div class="flex items-end space-x-2">
                    <!-- File Input & Select Button -->
                    <div class="flex flex-col space-y-1">
                        <input type="file" id="file-input" class="hidden" />
                        <button id="select-file-button" class="p-2 bg-gray-600 hover:bg-gray-500 rounded-full text-gray-300 transition duration-150 shadow-md flex-shrink-0" title="Attach File">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586A4 4 0 0012 5.586V4a1 1 0 00-1-1H7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V6a1 1 0 011-1h2.172z" /></svg>
                        </button>
                        <button id="clear-file-button" class="p-2 bg-red-600 hover:bg-red-500 rounded-full text-white transition duration-150 shadow-md flex-shrink-0" title="Clear File">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>

                    <!-- Message Textarea -->
                    <textarea id="message-input" rows="1" class="flex-grow resize-none p-3 rounded-xl bg-gray-800 border border-gray-600 text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 focus:outline-none transition duration-150" placeholder="Message #global-chat..."></textarea>
                    
                    <!-- Emoji Picker Button (Placeholder) -->
                    <button id="emoji-picker-button" class="p-2 bg-gray-600 hover:bg-gray-500 rounded-full text-gray-300 transition duration-150 shadow-md flex-shrink-0" title="Emojis (Coming Soon)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </button>

                    <!-- Send Button -->
                    <button id="send-button" class="p-3 bg-indigo-600 hover:bg-indigo-700 rounded-full text-white font-semibold transition duration-150 shadow-md flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" /></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings/User Info Bar (Bottom Right) -->
        <div id="user-info-bar" class="absolute bottom-0 right-0 m-4 hidden">
             <button id="settings-button" class="flex items-center space-x-2 p-2 bg-gray-700 rounded-full shadow-xl hover:bg-gray-600 transition duration-150">
                 <!-- Profile Picture Placeholder -->
                <img id="pfp-thumbnail" class="w-8 h-8 rounded-full border-2 border-indigo-400 object-cover" src="https://placehold.co/32x32/1f2937/9ca3af?text=U" alt="Profile Picture">
                <span class="text-sm font-semibold pr-1">Settings</span>
            </button>
        </div>

    </div>

    <!-- Modal for Server Creation -->
    <div id="server-modal-bg" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md shadow-2xl">
            <h3 class="text-2xl font-bold text-indigo-400 mb-4">Create New Server</h3>
            <p class="text-gray-400 mb-4">Enter a name for your new collaborative server.</p>
            <input type="text" id="server-name-input" class="w-full p-3 rounded-lg bg-gray-900 border border-gray-600 text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="Server Name">
            <div class="flex justify-end space-x-3">
                <button id="cancel-server-button" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg transition duration-150">Cancel</button>
                <button id="create-server-button" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-semibold transition duration-150">Create Server</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal-bg" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-xl w-full max-w-lg shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-3xl font-bold text-indigo-400">User Settings</h3>
                <button id="close-settings-button" class="text-gray-400 hover:text-white transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <!-- Profile Preview/Banner -->
            <div id="profile-preview" class="mb-6 relative">
                <img id="banner-preview" class="w-full h-32 object-cover rounded-lg border-2 border-gray-700" src="https://placehold.co/800x200/374151/9ca3af?text=BANNER" alt="Banner Preview">
                <img id="pfp-preview" class="absolute left-4 -bottom-10 w-24 h-24 object-cover rounded-full border-4 border-gray-800" src="https://placehold.co/96x96/1f2937/9ca3af?text=U" alt="Profile Picture Preview">
                <div class="absolute left-32 -bottom-4">
                    <input type="text" id="profile-name-input" class="text-2xl font-bold bg-transparent border-b border-indigo-400 focus:outline-none focus:border-indigo-300" value="Authenticated User">
                </div>
            </div>
            <div class="pt-12 border-b border-gray-700 pb-6"></div>

            <!-- Profile Customization -->
            <h4 class="text-xl font-semibold mt-6 mb-3 text-gray-300">Customization</h4>
            
            <!-- PFP Upload -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-400 mb-1">Profile Picture (PNG, GIF, etc.)</label>
                <input type="file" id="pfp-file-input" class="hidden" accept="image/*">
                <div class="flex space-x-3">
                    <button id="upload-pfp-button" class="flex-grow px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-semibold transition duration-150">Upload New PFP</button>
                    <button id="remove-pfp-button" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition duration-150">Remove PFP</button>
                </div>
                <p id="pfp-upload-status" class="mt-2 text-sm text-gray-500"></p>
                <!-- Reuse progress bar from file upload status area but hide the full status block -->
            </div>

            <!-- Banner URL Input -->
            <div class="mb-6">
                <label for="banner-url-input" class="block text-sm font-medium text-gray-400 mb-1">Banner Image URL</label>
                <input type="text" id="banner-url-input" class="w-full p-3 rounded-lg bg-gray-900 border border-gray-600 text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Paste image URL (PNG, JPG, GIF)">
            </div>
            
            <button id="save-profile-button" class="w-full p-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition duration-150 mb-6">Save Profile Changes</button>
            <p id="profile-save-status" class="mt-2 text-sm text-center font-medium"></p>
            
            <!-- Account Info -->
            <h4 class="text-xl font-semibold mt-6 mb-3 text-gray-300 border-t border-gray-700 pt-6">Account Info</h4>
            
            <div class="mb-4 bg-gray-900 p-4 rounded-lg flex justify-between items-center">
                <span class="text-sm font-medium text-gray-400">Your Unique Access Code:</span>
                <div class="flex items-center space-x-3">
                    <span id="display-access-code" class="text-lg font-mono text-indigo-300 code-blur">***********</span>
                    <button id="toggle-code-button" class="px-3 py-1 text-xs bg-indigo-500 hover:bg-indigo-400 rounded transition duration-150">Show</button>
                </div>
            </div>

            <!-- Log Out -->
            <button id="logout-button" class="w-full p-3 bg-red-700 hover:bg-red-600 rounded-lg font-semibold transition duration-150 mt-6">Log Out (Clear Session)</button>
        </div>
    </div>

    <!-- Modal for Changelog/Notifications (Hidden for brevity, original logic remains) -->
    <div id="changelog-modal-bg" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <!-- ... content not visible for this update ... -->
    </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, query, onSnapshot, orderBy, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// =================================
// 1. CONFIGURATION (EDIT ME)
// =================================

// --- Access Codes (10 digits) ---
const ACCESS_CODES = [
"2879556054", // David
"0009029674", // Camden
"5815287646", // Garrett
"0269927548", // Isaac
"7950368985", // Amir
];

// --- Placeholder Firebase Config (Fallback for External Hosting) ---
const PLACEHOLDER_FIREBASE_CONFIG = {
apiKey: "AIzaSyCDu1T73_HOaxC5gtHTNHev8HIfPSwbsqc",
authDomain: "knokbak-message-panel.firebaseapp.com",
projectId: "knokbak-message-panel",
storageBucket: "knokbak-message-panel.firebasestorage.app",
messagingSenderId: "424259711684",
appId: "1:424259711684:web:6818525d64024815604f91"
};
const PLACEHOLDER_APP_ID = 'knokbak-message-panel';

// --- File Upload Configuration ---
const MAX_FILE_SIZE_MB = 500;
const UPLOAD_ENDPOINT = "https://school-upload-worker-endpoint.garrett23-main-garrettlol.workers.dev";
const UPLOAD_AUTH_TOKEN = "Sch00lUpl0ad2025";
const CDN_BASE_URL = "https://cdna.knokbak.com/downloadable/share/";

// --- Default Profile Images ---
const DEFAULT_PFP_URL = "https://placehold.co/96x96/1f2937/9ca3af?text=U";
const DEFAULT_BANNER_URL = "https://placehold.co/800x200/374151/9ca3af?text=BANNER";
// =================================


// 2. GLOBAL VARIABLES
let app, db, auth, userId = null;
let currentAppId = PLACEHOLDER_APP_ID; 
let attachedFile = null; 
let uploadedFileUrl = null; 
let webhookUrl = "https://discord.com/api/webhooks/1436501315340603444/dBximNVW0hE5I2AACU3lfrbYhEWrSmpU8bP9cY-2TI83sw-u1GQxsElup0Iw7LmC2WX-"; 

// Profile State
let currentUserProfile = {
    accessCode: null,
    displayName: 'Guest User',
    pfpUrl: DEFAULT_PFP_URL,
    bannerUrl: DEFAULT_BANNER_URL,
};
// Cache to store other users' profile data (PFP/Name)
let userProfilesCache = {}; 

// Changelog/Notification Variables
let isChangelogOpen = false;
let newMessageCount = 0;


// 3. ELEMENT REFERENCES
const codeScreen = document.getElementById('code-screen');
const sidebar = document.getElementById('sidebar');
const chatPanel = document.getElementById('chat-panel');
const messagesContainer = document.getElementById('messages-container');
const loadingStatus = document.getElementById('loading-status');
const codeError = document.getElementById('code-error');
const accessCodeInput = document.getElementById('access-code-input');
const enterCodeButton = document.getElementById('enter-code-button');

const messageInput = document.getElementById('message-input');
const sendButton = document.getElementById('send-button');

const fileInput = document.getElementById('file-input');
const selectFileButton = document.getElementById('select-file-button');
const clearFileButton = document.getElementById('clear-file-button');
const fileNameDisplay = document.getElementById('file-name-display');
const fileStatusAndProgress = document.getElementById('file-status-and-progress');
const uploadProgressBar = document.getElementById('upload-progress-bar');
const progressBarFill = document.getElementById('progress-bar-fill');

const settingsButton = document.getElementById('settings-button');
const settingsModalBg = document.getElementById('settings-modal-bg');
const closeSettingsButton = document.getElementById('close-settings-button');
const pfpThumbnail = document.getElementById('pfp-thumbnail');
const pfpPreview = document.getElementById('pfp-preview');
const bannerPreview = document.getElementById('banner-preview');
const profileNameInput = document.getElementById('profile-name-input');
const displayAccessCode = document.getElementById('display-access-code');
const toggleCodeButton = document.getElementById('toggle-code-button');
const uploadPfpButton = document.getElementById('upload-pfp-button');
const removePfpButton = document.getElementById('remove-pfp-button');
const pfpFileInput = document.getElementById('pfp-file-input');
const pfpUploadStatus = document.getElementById('pfp-upload-status');
const bannerUrlInput = document.getElementById('banner-url-input');
const saveProfileButton = document.getElementById('save-profile-button');
const profileSaveStatus = document.getElementById('profile-save-status');
const logoutButton = document.getElementById('logout-button');

const addServerButton = document.getElementById('add-server-button');
const serverModalBg = document.getElementById('server-modal-bg');
const cancelServerButton = document.getElementById('cancel-server-button');


// 4. UTILITY FUNCTIONS
function showMessage(message, isError = false) {
    codeError.textContent = message;
    codeError.classList.remove('text-red-400', 'text-green-400', 'opacity-0');
    codeError.classList.add(isError ? 'text-red-400' : 'text-green-400', 'opacity-100');
    if (!isError) {
        setTimeout(() => {
            codeError.classList.add('opacity-0');
        }, 5000);
    }
}

/**
 * Updates the status message in the file input area.
 */
function updateFileStatus(message, isError = false) {
    fileNameDisplay.textContent = message;
    fileNameDisplay.className = isError ? 'text-red-400' : 'text-green-400';
}

/**
 * Formats Firestore timestamp to local timezone string (e.g., "Today at 06:00 PM").
 */
function formatTimestamp(timestamp) {
    if (!timestamp) return 'Time Unknown';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const today = new Date().toDateString();
    const messageDate = date.toDateString();
    
    if (today === messageDate) {
        return `Today at ${timeString}`;
    }
    return date.toLocaleString([], {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// 5. PROFILE AND DATA MANAGEMENT

/**
 * Fetches the current user's profile data from Firestore.
 */
async function loadUserProfile(userId) {
    const profileDocPath = `/artifacts/${currentAppId}/users/${userId}/profile/user_data`;
    const docRef = doc(db, profileDocPath);
    
    try {
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
            const data = docSnap.data();
            console.log("Loaded profile data:", data);
            
            // Merge loaded data with current profile state
            currentUserProfile = {
                ...currentUserProfile,
                displayName: data.displayName || currentUserProfile.displayName,
                pfpUrl: data.pfpUrl || currentUserProfile.pfpUrl,
                bannerUrl: data.bannerUrl || currentUserProfile.bannerUrl,
                // accessCode is set during initial login
            };
        }
        
    } catch (e) {
        console.error("Error loading user profile:", e);
    }
}

/**
 * Saves the current user's profile data to Firestore.
 */
async function saveUserProfile(profile) {
    const profileDocPath = `/artifacts/${currentAppId}/users/${userId}/profile/user_data`;
    const docRef = doc(db, profileDocPath);
    
    try {
        await setDoc(docRef, {
            displayName: profile.displayName,
            pfpUrl: profile.pfpUrl,
            bannerUrl: profile.bannerUrl,
            lastUpdated: serverTimestamp()
        }, { merge: true });
        
        console.log("Profile saved successfully.");
        // Update local state
        currentUserProfile = profile;
        // Update UI
        updateProfileUI();
        profileSaveStatus.textContent = "Profile saved!";
        profileSaveStatus.classList.remove('text-red-400');
        profileSaveStatus.classList.add('text-green-400');
        
        // Wait 3 seconds, then clear status
        setTimeout(() => {
            profileSaveStatus.textContent = "";
        }, 3000);
        
    } catch (e) {
        console.error("Error saving user profile:", e);
        profileSaveStatus.textContent = "Failed to save profile: " + e.message;
        profileSaveStatus.classList.remove('text-green-400');
        profileSaveStatus.classList.add('text-red-400');
    }
}

/**
 * Fetches and caches all available user profile data for message rendering.
 * In a real app, this would be scoped to only users in the current channel/server.
 */
async function cacheAllUserProfiles() {
    // This is a simplified fetch from the private path of the current user. 
    // For a multi-user cache, we would need a public 'user_metadata' collection 
    // accessible to everyone. Since we're restricted to the current user's 
    // private path and public chat, we'll cache the hardcoded users if possible.
    
    // For now, we only cache the current user's profile for local rendering.
    userProfilesCache[userId] = currentUserProfile;
}

/**
 * Updates all relevant UI elements (thumbnail, preview, inputs) based on currentUserProfile.
 */
function updateProfileUI() {
    const { displayName, pfpUrl, bannerUrl, accessCode } = currentUserProfile;
    
    // Chat input name (if not using the settings modal's input)
    // We'll use the profileNameInput in the settings modal to manage this.

    // Thumbnail and Previews
    pfpThumbnail.src = pfpUrl;
    pfpPreview.src = pfpUrl;
    bannerPreview.src = bannerUrl;
    
    // Settings inputs
    profileNameInput.value = displayName;
    bannerUrlInput.value = bannerUrl === DEFAULT_BANNER_URL ? '' : bannerUrl;
    
    // Access Code Display
    displayAccessCode.textContent = accessCode || '***********';
}


// 6. INITIALIZATION & AUTHENTICATION

// Initialize Firebase
async function initializeFirebase() {
    // ... (Configuration remains the same) ...
    let config = PLACEHOLDER_FIREBASE_CONFIG;
    let appId = PLACEHOLDER_APP_ID;
    if (typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0) {
        config = JSON.parse(__firebase_config);
    }
    if (typeof __app_id !== 'undefined') {
        appId = __app_id;
    }
    currentAppId = appId;
    
    try {
        app = initializeApp(config);
        db = getFirestore(app);
        auth = getAuth(app);
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }

        return new Promise((resolve) => {
             onAuthStateChanged(auth, (user) => {
                userId = user ? user.uid : crypto.randomUUID();
                console.log("Authenticated User ID:", userId);
                resolve(true);
            });
        });
        
    } catch (e) {
        console.error("Firebase initialization failed:", e);
        showMessage("Firebase connection error. Check console.", true);
        return false;
    }
}

// Check access code validity and log the user in
async function validateCode(code) {
    const codeInput = code.toUpperCase().trim();
    if (codeInput.length !== 10) {
        showMessage("Code must be 10 characters long.", true);
        return;
    }
    
    if (!db) {
        showMessage("Database not connected. Please wait.", true);
        return;
    }

    const validNames = {
        "2879556054": "David",
        "0009029674": "Camden",
        "5815287646": "Garrett",
        "0269927548": "Isaac",
        "7950368985": "Amir",
        
    };
    
    const isValid = ACCESS_CODES.includes(codeInput) || Object.keys(validNames).includes(codeInput);

    if (isValid) {
        const userName = validNames[codeInput] || 'Authenticated User';
        
        // 1. Set global profile state
        currentUserProfile.accessCode = codeInput;
        currentUserProfile.displayName = userName;

        // 2. Load persistent profile settings (PFP/Banner)
        await loadUserProfile(userId);

        // 3. Update UI based on final profile state
        updateProfileUI();

        // 4. Transition UI
        codeScreen.classList.add('hidden');
        sidebar.classList.remove('hidden');
        chatPanel.classList.remove('hidden', 'opacity-0');
        document.getElementById('user-info-bar').classList.remove('hidden');
        
        // 5. Start listening to the chat
        listenForMessages();

    } else {
        showMessage("Invalid code. Access denied.", true);
    }
}


// 7. FILE UPLOAD LOGIC (REUSED/MODIFIED)

// Reuses the file upload logic for both message attachments and PFP/Banner uploads
async function uploadFile(file, isPfp = false) {
    const formData = new FormData();
    formData.append('file', file);
    
    const statusElement = isPfp ? pfpUploadStatus : fileNameDisplay;
    const progressFillElement = isPfp ? progressBarFill : progressBarFill; // Reusing the same bar for PFP status

    // START: Loading/Progress State
    if (!isPfp) {
        fileStatusAndProgress.classList.remove('hidden');
        uploadProgressBar.classList.remove('hidden');
    }
    progressFillElement.style.width = '50%';
    statusElement.textContent = `Uploading ${file.name}...`;
    statusElement.className = isPfp ? 'mt-2 text-sm text-yellow-400' : 'text-yellow-400';
    
    try {
        const response = await fetch(UPLOAD_ENDPOINT, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Upload-Auth': UPLOAD_AUTH_TOKEN
            }
        });

        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(`Upload failed (${response.status} - ${response.statusText}): ${errorData}`);
        }

        const result = await response.json();
        
        progressFillElement.style.width = '100%';
        statusElement.textContent = `Upload Complete: ${file.name}`;
        statusElement.className = isPfp ? 'mt-2 text-sm text-green-400' : 'text-green-400';
        
        setTimeout(() => {
            if (!isPfp) {
                 uploadProgressBar.classList.add('hidden');
                 fileStatusAndProgress.classList.add('hidden'); 
            } else {
                statusElement.textContent = '';
            }
        }, 1500);

        return result.url; 

    } catch (error) {
        if (!isPfp) {
            uploadProgressBar.classList.add('hidden');
            progressFillElement.style.width = '0%';
            updateFileStatus(`Error: ${error.message}`, true);
            attachedFile = null; uploadedFileUrl = null; fileInput.value = '';
        } else {
            statusElement.textContent = `Error: ${error.message}`;
            statusElement.className = 'mt-2 text-sm text-red-400';
        }
        throw error;
    }
}

// 8. CHAT & MESSAGE LOGIC

function clearAttachedFile() {
    attachedFile = null;
    uploadedFileUrl = null;
    fileInput.value = '';
    fileStatusAndProgress.classList.add('hidden');
    progressBarFill.style.width = '0%';
    fileNameDisplay.className = 'text-sm text-gray-300 font-medium truncate mb-1';
    fileNameDisplay.textContent = '';
}

// Creates a media embed/link based on file type
function createAttachmentHTML(url) {
    if (!url) return '';
    const fileExtension = url.split('.').pop().toLowerCase();
    let mediaHTML = '';
    if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(fileExtension)) {
        mediaHTML = `<img src="${url}" class="max-w-full h-auto rounded-lg mt-2 cursor-pointer" onerror="this.outerHTML='<p class=\\'text-red-400\\'>Failed to load image. <a href=\\'${url}\\' target=\\'_blank\\' class=\\'underline\\'>View Link</a></p>'" onclick="window.open('${url}', '_blank')" />`;
    } else if (['mp4', 'webm'].includes(fileExtension)) {
        mediaHTML = `<video src="${url}" controls class="max-w-full h-auto rounded-lg mt-2"></video>`;
    } else {
        mediaHTML = `<a href="${url}" target="_blank" class="text-blue-400 hover:text-blue-300 underline block mt-2 break-words">ðŸ“Ž Attachment: ${url.split('/').pop()}</a>`;
    }
    return `<div class="bg-gray-800 p-2 rounded-lg border border-gray-700 mt-2">${mediaHTML}</div>`;
}


// Creates a message bubble HTML element, now with PFP and improved time format
function createMessageElement(data) {
    const isSelf = data.senderId === userId;
    const time = formatTimestamp(data.timestamp);
    const attachmentHTML = createAttachmentHTML(data.attachmentUrl);

    // Use current user's profile for their messages, otherwise a placeholder
    const profile = isSelf ? currentUserProfile : (userProfilesCache[data.senderId] || { 
        displayName: data.senderName, 
        pfpUrl: DEFAULT_PFP_URL 
    });

    const pfp = profile.pfpUrl;
    const displayName = profile.displayName;
    const nameColor = 'text-indigo-400'; // Uniform color for name

    const div = document.createElement('div');
    div.className = `flex ${isSelf ? 'justify-end' : 'justify-start'} w-full`;
    div.innerHTML = `
        <div class="flex items-start max-w-lg space-x-3 ${isSelf ? 'flex-row-reverse space-x-reverse' : 'flex-row'}">
            <img class="w-10 h-10 rounded-full object-cover mt-1 flex-shrink-0 border-2 border-gray-600" src="${pfp}" onerror="this.src='${DEFAULT_PFP_URL}'" alt="${displayName} PFP">
            
            <div class="p-3 rounded-xl shadow-md ${isSelf ? 'bg-indigo-600 text-white' : 'bg-gray-700 text-gray-100'} max-w-full">
                <div class="text-sm font-bold mb-1 ${nameColor}">${displayName} <span class="text-xs font-normal text-gray-400 ml-2">${time}</span></div>
                <div class="text-base whitespace-pre-wrap break-words">${data.text || ''}</div>
                ${attachmentHTML}
            </div>
        </div>
    `;
    return div;
}


// Listens for real-time messages from Firestore
function listenForMessages() {
    const messagesCollectionPath = `/artifacts/${currentAppId}/public/data/messages`;
    const messagesQuery = query(collection(db, messagesCollectionPath), orderBy('timestamp'));

    if (loadingStatus) {
        loadingStatus.remove();
    }

    onSnapshot(messagesQuery, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            const data = { id: change.doc.id, ...change.doc.data() };

            if (change.type === "added") {
                const newElement = createMessageElement(data);
                messagesContainer.appendChild(newElement);

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        });
    }, (error) => {
        console.error("Error listening to messages:", error);
        messagesContainer.innerHTML = `<p class="text-red-500 p-4">Failed to load chat history.</p>`;
    });
}

// Sends the message to Firestore and Discord
async function sendMessage() {
    if (!db) {
        showMessage("Chat service not connected. Please refresh.", true);
        return;
    }

    const messageText = messageInput.value.trim();
    const senderName = currentUserProfile.displayName; 
    
    if (messageText === "" && !attachedFile) {
        showMessage("Please enter a message or select a file.", true);
        return;
    }
    
    sendButton.disabled = true;

    if (attachedFile && !uploadedFileUrl) {
        try {
            uploadedFileUrl = await uploadFile(attachedFile);
        } catch (e) {
            sendButton.disabled = false;
            return;
        }
    }
    
    if (messageText === "" && !uploadedFileUrl) {
         showMessage("Upload failed or URL is missing. Please try again.", true);
         sendButton.disabled = false;
         return;
    }

    const messagesCollectionPath = `/artifacts/${currentAppId}/public/data/messages`;
    const messagesRef = collection(db, messagesCollectionPath);
    
    updateFileStatus(attachedFile ? `Sending message and link...` : `Sending message...`);

    try {
        await setDoc(doc(messagesRef), {
            text: messageText,
            timestamp: serverTimestamp(),
            senderName: senderName,
            senderId: userId,
            attachmentUrl: uploadedFileUrl
        });
        
        // Post to Discord (webhook) - Non-blocking
        postToDiscord(messageText, senderName, uploadedFileUrl);

        messageInput.value = '';
        messageInput.style.height = 'auto';
        messageInput.focus();
        clearAttachedFile(); 
        showMessage(`Message sent successfully.`, false);
        
        sendButton.disabled = false;

    } catch (e) {
        console.error("Error sending message to Firestore:", e);
        showMessage('Failed to send message: ' + e.message, true);
        updateFileStatus(`Failed to save message: ${e.message}`, true);
        sendButton.disabled = false;
    }
}

// 9. EVENT LISTENERS

// --- Chat Input ---
sendButton.addEventListener('click', sendMessage);
messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); 
        sendMessage();
    }
});

messageInput.addEventListener('input', () => {
    messageInput.style.height = 'auto';
    messageInput.style.height = messageInput.scrollHeight + 'px';
});

selectFileButton.addEventListener('click', () => fileInput.click());
clearFileButton.addEventListener('click', clearAttachedFile);

fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) {
        clearAttachedFile();
        return;
    }

    if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
        showMessage(`File size exceeds the ${MAX_FILE_SIZE_MB}MB limit.`, true);
        clearAttachedFile();
        return;
    }

    attachedFile = file;
    fileNameDisplay.textContent = file.name;
    fileStatusAndProgress.classList.remove('hidden');
    showMessage(`File selected: ${file.name}`);
});

// --- Server Creation Modal ---
addServerButton.addEventListener('click', () => {
    serverModalBg.style.display = 'flex';
});

cancelServerButton.addEventListener('click', () => {
    serverModalBg.style.display = 'none';
});

// Create Server Button (Placeholder)
document.getElementById('create-server-button').addEventListener('click', () => {
    const serverName = document.getElementById('server-name-input').value.trim();
    if (serverName) {
        showMessage(`Feature coming soon: Created server "${serverName}"!`, false);
        serverModalBg.style.display = 'none';
        document.getElementById('server-name-input').value = '';
    } else {
        showMessage("Server name cannot be empty.", true);
    }
});

// --- Settings Modal ---

settingsButton.addEventListener('click', () => {
    // Populate modal inputs with current state before opening
    updateProfileUI(); 
    settingsModalBg.style.display = 'flex';
});

closeSettingsButton.addEventListener('click', () => {
    settingsModalBg.style.display = 'none';
});

// PFP Upload Handler
pfpFileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
        pfpUploadStatus.textContent = `File size exceeds the ${MAX_FILE_SIZE_MB}MB limit.`;
        pfpUploadStatus.classList.add('text-red-400');
        return;
    }

    try {
        const url = await uploadFile(file, true);
        pfpPreview.src = url;
        // Automatically update the profile state with the new PFP URL
        currentUserProfile.pfpUrl = url;
        pfpUploadStatus.textContent = `PFP uploaded. Click 'Save Profile Changes' to finalize.`;
    } catch (e) {
        // uploadFile already handles status
    }
});

uploadPfpButton.addEventListener('click', () => {
    pfpFileInput.click();
});

removePfpButton.addEventListener('click', () => {
    pfpPreview.src = DEFAULT_PFP_URL;
    currentUserProfile.pfpUrl = DEFAULT_PFP_URL;
    pfpUploadStatus.textContent = `PFP reset to default. Click 'Save Profile Changes'.`;
    pfpUploadStatus.classList.add('text-green-400');
});

// Save Profile Button
saveProfileButton.addEventListener('click', async () => {
    const newProfile = {
        accessCode: currentUserProfile.accessCode,
        displayName: profileNameInput.value.trim() || 'Anonymous',
        pfpUrl: currentUserProfile.pfpUrl, // Use the URL from the last upload/state
        bannerUrl: bannerUrlInput.value.trim() || DEFAULT_BANNER_URL
    };
    
    // Update PFP preview live (in case only banner URL or name changed)
    bannerPreview.src = newProfile.bannerUrl;
    
    await saveUserProfile(newProfile);
});

// Toggle Access Code Visibility
toggleCodeButton.addEventListener('click', () => {
    const codeElement = document.getElementById('display-access-code');
    const isBlurred = codeElement.classList.contains('code-blur');
    
    if (isBlurred) {
        codeElement.classList.remove('code-blur');
        toggleCodeButton.textContent = "Hide";
    } else {
        codeElement.classList.add('code-blur');
        toggleCodeButton.textContent = "Show";
    }
});

// Log Out (Clears session)
logoutButton.addEventListener('click', () => {
    // Simple log out: refresh the page to force re-authentication
    location.reload();
});


// --- Webhook (Post to Discord) ---
async function postToDiscord(message, senderName, attachmentUrl = null) {
    if (!webhookUrl || !webhookUrl.includes("discord.com/api/webhooks")) {
        console.error("Webhook not configured or invalid.");
        return;
    }

    const payload = {
        content: message,
        username: senderName,
        avatar_url: currentUserProfile.pfpUrl, // Use set PFP
        embeds: attachmentUrl ? [{ title: "File Attachment", url: attachmentUrl }] : []
    };
    
    // Only send attachment link in content if there's no text message
    if (message.trim() === "" && attachmentUrl) {
         payload.content = attachmentUrl;
    } else if (message.trim() !== "" && attachmentUrl) {
        // Append link to content if there's text
        payload.content += `\n\n[Attachment Link](${attachmentUrl})`;
    }


    try {
        await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
    } catch (e) {
        console.error("Network Error posting to Discord:", e);
    }
}


// --- Initialization ---
document.addEventListener('DOMContentLoaded', async () => {
    if (await initializeFirebase()) {
        enterCodeButton.addEventListener('click', () => validateCode(accessCodeInput.value));
        accessCodeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') validateCode(accessCodeInput.value);
        });
    } else {
        codeScreen.innerHTML = '<h1 class="text-3xl font-bold text-red-500">Initialization Error</h1><p class="text-gray-400 mt-4 text-center">Could not connect to Firebase. Check your configuration and network.</p>';
    }
});
</script>