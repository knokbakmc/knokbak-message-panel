<div class="min-h-screen bg-gray-900 text-gray-100 flex items-center justify-center p-4">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let currentUserData = null; // Stores user profile data
        let currentServerId = 'global'; // Start on 'global'
        let unsubscribeMessages = null;
        let unsubscribeUsers = null;
        let isAdmin = false;
        let isAuthReady = false;

        const ADMIN_ID = "5815287646";
        const ADMIN_PASSWORD = "mysubsarethebest";
        const MESSAGES_COLLECTION_PATH = `/artifacts/${appId}/public/data/messages`;
        const USERS_COLLECTION_PATH = `/artifacts/${appId}/public/data/users`;
        const CODES_COLLECTION_PATH = `/artifacts/${appId}/public/data/codes`; // New collection for code lookup
        
        // --- Utility Functions ---

        // Simple debounce function to limit function calls
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // --- Auth and Init ---

        async function initFirebase() {
            try {
                // Check if Firebase config is usable
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                    document.getElementById('loading-status').textContent = "Initialization failed: Missing Firebase configuration details.";
                    console.error("Firebase config is missing or incomplete.");
                    // Keep the user on the code screen if config is missing.
                    return; 
                }
                
                setLogLevel('error'); // Use 'error' to suppress spammy debug logs
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Set persistence to session to maintain login across reloads
                await setPersistence(auth, browserSessionPersistence);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Wait for auth state to be resolved
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        currentUserId = user.uid;
                        isAdmin = currentUserId === ADMIN_ID;
                        document.getElementById('loading-status').textContent = "Authenticated successfully. Loading profile...";
                        handleSuccessfulAuth();
                    } else {
                        currentUserId = null;
                        document.getElementById('loading-status').textContent = "Signed out. Enter your code to continue.";
                        // If user is null, revert to login screen (unless it's a forced logout timer)
                        if (!document.getElementById('force-logout-timer').classList.contains('hidden')) return;
                        showCodeScreen();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loading-status').textContent = `Initialization Error: ${error.message}`;
                showCodeScreen();
            }
        }
        
        function showCodeScreen() {
            // This function is mainly used after a forced logout.
            document.getElementById('code-screen').classList.remove('hidden');
            document.getElementById('code-screen').style.opacity = '1';
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('chat-panel').classList.add('hidden');
            document.getElementById('user-info-bar').classList.add('hidden');
            document.getElementById('members-panel').classList.add('hidden');
        }

        async function handleSuccessfulAuth() {
            // Fetch or create user profile data
            await fetchUserProfile();
            
            // UI transitions
            document.getElementById('code-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('code-screen').classList.add('hidden');
            }, 500);

            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('chat-panel').classList.remove('hidden');
            document.getElementById('chat-panel').style.opacity = '1';
            document.getElementById('user-info-bar').classList.remove('hidden');
            
            // Set initial UI elements
            updateUserInfoBar();
            
            // Start listening for messages and users
            startListeners();
        }
        
        // --- Code Management ---
        
        async function saveAccessCode(code, userId) {
            try {
                // The code is the document ID, pointing to the user ID
                const codeRef = doc(db, CODES_COLLECTION_PATH, code);
                await setDoc(codeRef, { userId: userId });
            } catch (e) {
                console.error("Error saving access code:", e);
                showMessageBox("Error saving new access code.", true);
                return false;
            }
            return true;
        }

        async function deleteAccessCode(code) {
            try {
                const codeRef = doc(db, CODES_COLLECTION_PATH, code);
                await deleteDoc(codeRef);
            } catch (e) {
                console.error("Error deleting access code:", e);
                // Note: We don't show a messagebox here as it's a background cleanup task
            }
        }
        
        // --- User Profile Management ---
        
        async function fetchUserProfile() {
            if (!currentUserId || !isAuthReady) return;
            const userRef = doc(db, USERS_COLLECTION_PATH, currentUserId);
            const userSnap = await getDoc(userRef);

            const defaultUsername = "User";
            const defaultTag = (currentUserId.slice(-4) || '0000');
            const defaultPfp = `https://placehold.co/80x80/374151/9ca3af?text=${defaultUsername.charAt(0)}`;
            const defaultAboutMe = "A member of the School Chat community.";
            const defaultCode = currentUserId.slice(0, 10); // Default code is the first 10 chars of UID

            if (userSnap.exists()) {
                currentUserData = userSnap.data();
                // Ensure required fields exist in case of old data structure
                currentUserData = {
                    accessCode: currentUserData.accessCode || defaultCode,
                    username: currentUserData.username || defaultUsername,
                    tag: currentUserData.tag || defaultTag,
                    pfpUrl: currentUserData.pfpUrl || defaultPfp,
                    aboutMe: currentUserData.aboutMe || defaultAboutMe,
                    isAdmin: isAdmin
                };
            } else {
                // Create a new default profile
                currentUserData = {
                    accessCode: defaultCode,
                    username: defaultUsername,
                    tag: defaultTag,
                    pfpUrl: defaultPfp,
                    aboutMe: defaultAboutMe,
                    isAdmin: isAdmin
                };
                await setDoc(userRef, currentUserData);
                // Create the initial code mapping
                await saveAccessCode(defaultCode, currentUserId);
            }
        }
        
        async function saveUserProfile() {
            if (!currentUserId || !currentUserData) {
                showMessageBox("Profile not loaded. Please wait.", true);
                return;
            }
            
            const oldCode = currentUserData.accessCode;
            const newCode = document.getElementById('access-code-edit-input').value.trim();
            const username = document.getElementById('username-input').value.trim();
            const tag = document.getElementById('tag-input').value.trim();
            const pfpUrl = document.getElementById('pfp-url-input').value.trim();
            const aboutMe = document.getElementById('about-me-input').value.trim();
            
            if (!username || !tag || tag.length !== 4 || isNaN(tag)) {
                showMessageBox("Username and 4-digit numeric Tag are required.", true);
                return;
            }
            
            if (newCode.length !== 10 || isNaN(newCode)) {
                showMessageBox("Access Code must be exactly 10 numeric digits.", true);
                return;
            }
            
            currentUserData.username = username;
            currentUserData.tag = tag;
            currentUserData.pfpUrl = pfpUrl || `https://placehold.co/100x100/374151/9ca3af?text=${username.charAt(0)}`;
            currentUserData.aboutMe = aboutMe;
            
            // --- Code Change Logic ---
            if (oldCode !== newCode) {
                // 1. Check if the new code is already in use by another user
                const codeSnap = await getDoc(doc(db, CODES_COLLECTION_PATH, newCode));
                if (codeSnap.exists() && codeSnap.data().userId !== currentUserId) {
                    showMessageBox(`Error: Access Code "${newCode}" is already in use by another account.`, true);
                    return;
                }
                
                // 2. Delete old code mapping
                await deleteAccessCode(oldCode);
                
                // 3. Save new code mapping
                if (!await saveAccessCode(newCode, currentUserId)) {
                    // Revert user data to old code if saving new code fails
                    currentUserData.accessCode = oldCode;
                    await saveAccessCode(oldCode, currentUserId); // Attempt to re-save the old one
                    return; 
                }
                
                currentUserData.accessCode = newCode;
            }
            // --- End Code Change Logic ---

            const userRef = doc(db, USERS_COLLECTION_PATH, currentUserId);
            try {
                await setDoc(userRef, {
                    ...currentUserData,
                    updatedAt: serverTimestamp()
                }, { merge: true });
                updateUserInfoBar();
                showMessageBox("Profile updated successfully!");
                document.getElementById('settings-modal-bg').classList.add('hidden');
            } catch (e) {
                console.error("Error saving user profile:", e);
                showMessageBox("Error saving profile. Try again.", true);
            }
        }
        
        function updateUserInfoBar() {
            if (!currentUserData) return;
            const displayName = `${currentUserData.username || 'User'}#${currentUserData.tag || '0000'}`;
            document.getElementById('user-name-display').textContent = displayName;
            document.getElementById('pfp-thumbnail').src = currentUserData.pfpUrl;
            document.getElementById('pfp-thumbnail').onerror = () => {
                document.getElementById('pfp-thumbnail').src = `https://placehold.co/32x32/374151/9ca3af?text=${(currentUserData.username || 'U').charAt(0)}`;
            };
        }

        // --- Message CRUD (Omitted for brevity, assume unchanged) ---
        // ... (sendMessage, editMessage, deleteMessage remain the same) ...
        
        async function sendMessage(text, imageUrl = null) {
            if (!currentUserId || !currentUserData || text.trim() === '') return;

            const message = {
                userId: currentUserId,
                username: currentUserData.username,
                tag: currentUserData.tag,
                pfpUrl: currentUserData.pfpUrl,
                content: text,
                server: currentServerId,
                timestamp: serverTimestamp(),
                imageUrl: imageUrl,
                isEdited: false
            };

            try {
                await addDoc(collection(db, MESSAGES_COLLECTION_PATH), message);
                document.getElementById('message-input').value = '';
                // Clear file state after successful send
                clearFileAttachment();
                // Scroll to bottom
                setTimeout(scrollToBottom, 100);
            } catch (e) {
                console.error("Error sending message:", e);
                showMessageBox("Failed to send message.", true);
            }
        }
        
        async function editMessage(messageId, newContent) {
            if (!currentUserId) return;
            const messageRef = doc(db, MESSAGES_COLLECTION_PATH, messageId);
            
            try {
                await updateDoc(messageRef, {
                    content: newContent,
                    isEdited: true,
                    editedAt: serverTimestamp()
                });
            } catch (e) {
                console.error("Error editing message:", e);
                showMessageBox("Failed to edit message.", true);
            }
        }
        
        async function deleteMessage(messageId) {
            if (!currentUserId) return;
            const messageRef = doc(db, MESSAGES_COLLECTION_PATH, messageId);
            
            try {
                await deleteDoc(messageRef);
            } catch (e) {
                console.error("Error deleting message:", e);
                showMessageBox("Failed to delete message.", true);
            }
        }

        // --- Realtime Listeners (Omitted for brevity, assume unchanged) ---
        
        function startListeners() {
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeUsers) unsubscribeUsers();

            const messagesQuery = query(
                collection(db, MESSAGES_COLLECTION_PATH),
                where('server', '==', currentServerId)
            );

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                let messagesHTML = '';
                snapshot.docs.forEach(doc => {
                    messagesHTML += createMessageHTML(doc.id, doc.data());
                });
                document.getElementById('messages-container').innerHTML = messagesHTML;
                scrollToBottom();
            }, (error) => {
                console.error("Error listening to messages:", error);
            });
            
            const usersQuery = query(collection(db, USERS_COLLECTION_PATH));
            
            unsubscribeUsers = onSnapshot(usersQuery, (snapshot) => {
                window.allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!document.getElementById('members-panel').classList.contains('hidden')) {
                    displayMembersList();
                }
            }, (error) => {
                console.error("Error listening to users:", error);
            });
        }
        
        // --- UI Rendering (Omitted for brevity, assume unchanged except for event handlers) ---
        
        function createMessageHTML(id, message) {
            const isCurrentUser = message.userId === currentUserId;
            const displayName = `${message.username}#${message.tag}`;
            const time = message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '...';
            const isEdited = message.isEdited ? `<span class="text-xs text-gray-400 ml-2">(edited)</span>` : '';
            const pfpUrl = message.pfpUrl || `https://placehold.co/40x40/374151/9ca3af?text=${message.username.charAt(0)}`;

            let imageHtml = '';
            if (message.imageUrl) {
                imageHtml = `<img src="${message.imageUrl}" class="mt-2 max-w-xs max-h-48 object-contain rounded-lg shadow-md border border-gray-600" onerror="this.onerror=null;this.src='https://placehold.co/200x100/374151/9ca3af?text=Image+Load+Failed';" />`;
            }

            return `
                <div class="message-row flex group items-start space-x-3 p-2 hover:bg-gray-700/50 rounded-lg relative transition-colors duration-100 animate-slideIn" data-message-id="${id}" data-user-id="${message.userId}">
                    <!-- Profile Picture (Clickable) -->
                    <img src="${pfpUrl}" class="w-10 h-10 rounded-full object-cover cursor-pointer hover:opacity-80 transition duration-150 message-pfp" data-user-id="${message.userId}" alt="${message.username} PFP" 
                         onerror="this.onerror=null;this.src='https://placehold.co/40x40/374151/9ca3af?text=${message.username.charAt(0)}';">
                    
                    <div class="flex flex-col flex-grow min-w-0">
                        <!-- Header: Name, Tag, Time -->
                        <div class="flex items-baseline space-x-2">
                            <span class="font-bold text-indigo-300 cursor-pointer hover:text-indigo-200 transition duration-150 message-username" data-user-id="${message.userId}">${displayName}</span>
                            <span class="text-xs text-gray-500">${time}</span>
                        </div>
                        
                        <!-- Content -->
                        <div class="text-gray-200 break-words message-content-text">${message.content} ${isEdited}</div>
                        ${imageHtml}
                        
                        <!-- Hidden Edit/Delete Input -->
                        <textarea class="edit-input w-full resize-none p-2 mt-1 rounded-lg bg-gray-600 text-gray-100 hidden" data-message-id="${id}">${message.content}</textarea>
                        <div class="edit-actions mt-1 hidden space-x-2">
                            <button class="save-edit-btn bg-green-600 hover:bg-green-700 text-white text-xs px-2 py-1 rounded-full transition">Save</button>
                            <button class="cancel-edit-btn bg-gray-500 hover:bg-gray-600 text-white text-xs px-2 py-1 rounded-full transition">Cancel</button>
                        </div>
                    </div>
                    
                    <!-- Message Actions (Edit/Delete) -->
                    <div class="message-actions absolute right-0 top-0 mt-2 mr-2 flex items-center p-1 rounded-lg shadow-lg border border-gray-600 z-10">
                        ${(isCurrentUser || isAdmin) ? `<button class="edit-message-btn p-1 text-gray-400 hover:text-green-400" data-message-id="${id}" title="Edit Message"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-6l9 9m-4.5 4.5l-2.5 2.5m4.5-4.5l-9-9L3 17.25 10.75 21l-2.5-2.5z"/></svg></button>` : ''}
                        ${(isCurrentUser || isAdmin) ? `<button class="delete-message-btn p-1 text-gray-400 hover:text-red-400" data-message-id="${id}" title="Delete Message"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>` : ''}
                    </div>
                </div>
            `;
        }

        function displayMembersList(selectedUserId = null) {
            const membersPanel = document.getElementById('members-panel');
            membersPanel.classList.remove('hidden');

            const profileViewDetails = document.getElementById('profile-view-details');
            const adminControls = document.getElementById('admin-controls');
            
            const userIdToDisplay = selectedUserId || currentUserId;
            
            if (userIdToDisplay && window.allUsers) {
                const user = window.allUsers.find(u => u.id === userIdToDisplay);
                
                if (user) {
                    profileViewDetails.dataset.targetId = user.id; // Store ID for admin actions
                    document.getElementById('view-pfp').src = user.pfpUrl;
                    document.getElementById('view-pfp').onerror = () => {
                        document.getElementById('view-pfp').src = `https://placehold.co/80x80/1f2937/9ca3af?text=${user.username.charAt(0)}`;
                    };
                    document.getElementById('view-display-name').textContent = `${user.username}#${user.tag}`;
                    document.getElementById('view-access-code').textContent = `ID: ${user.id}`;
                    document.getElementById('view-about-me').value = user.aboutMe || "This user has not set an 'About Me' yet.";

                    // Show Admin Controls if current user is admin AND target user is not current user
                    if (isAdmin && user.id !== currentUserId) {
                        adminControls.classList.remove('hidden');
                        adminControls.dataset.targetId = user.id;
                    } else {
                        adminControls.classList.add('hidden');
                        delete adminControls.dataset.targetId;
                    }
                    
                    // Show right-click context menu listener only if the user is an admin
                    if (isAdmin) {
                        profileViewDetails.addEventListener('contextmenu', handleProfileContextMenu);
                    } else {
                        profileViewDetails.removeEventListener('contextmenu', handleProfileContextMenu);
                    }
                } else {
                    profileViewDetails.dataset.targetId = '';
                    document.getElementById('view-pfp').src = 'https://placehold.co/80x80/1f2937/9ca3af?text=U';
                    document.getElementById('view-display-name').textContent = 'User Not Found';
                    document.getElementById('view-access-code').textContent = '';
                    document.getElementById('view-about-me').value = 'Could not retrieve profile information.';
                    adminControls.classList.add('hidden');
                }
            }
        }
        
        function handleProfileContextMenu(e) {
            e.preventDefault();
            const targetId = e.currentTarget.dataset.targetId;
            if (!isAdmin || !targetId || targetId === currentUserId) return;

            const menu = document.createElement('div');
            menu.id = 'admin-context-menu';
            menu.className = 'absolute bg-gray-900 border border-gray-700 rounded-lg shadow-xl py-1 z-50';
            menu.style.left = `${e.pageX}px`;
            menu.style.top = `${e.pageY}px`;
            menu.innerHTML = `
                <button class="w-full text-left px-3 py-1 text-sm text-red-400 hover:bg-red-700/50 block transition" data-action="force-logout" data-user-id="${targetId}">Force Logout (25s)</button>
            `;
            
            document.body.appendChild(menu);

            document.addEventListener('click', () => {
                const existingMenu = document.getElementById('admin-context-menu');
                if (existingMenu) existingMenu.remove();
            }, { once: true });
        }
        
        // --- Admin/Moderation Logic (Omitted for brevity, assume unchanged) ---
        
        async function attemptAdminAction(action, targetUserId, value = '') {
            const password = await promptAdminPassword();
            if (password === null) return; // Cancelled
            if (password !== ADMIN_PASSWORD) {
                showMessageBox("Incorrect admin password.", true);
                return;
            }

            switch (action) {
                case 'timeout':
                    showMessageBox(`Admin action: Timeout user ${targetUserId} for ${value} minutes (Placeholder).`);
                    break;
                case 'warn':
                    showMessageBox(`Admin action: Warn user ${targetUserId} (Placeholder).`);
                    break;
                case 'ban':
                    showMessageBox(`Admin action: Ban server (Placeholder - not implemented).`);
                    break;
                case 'force-logout':
                    handleForceLogout(targetUserId);
                    break;
                default:
                    console.error("Unknown admin action:", action);
            }
        }
        
        async function promptAdminPassword() {
            return new Promise(resolve => {
                const modal = document.getElementById('admin-password-modal-bg');
                const input = document.getElementById('admin-password-input');
                const submitBtn = document.getElementById('admin-password-submit');
                const cancelBtn = document.getElementById('admin-password-cancel');
                const errorDiv = document.getElementById('admin-password-error');
                
                input.value = '';
                errorDiv.textContent = '';
                modal.classList.remove('hidden');

                const handler = (e) => {
                    const password = input.value;
                    if (password === ADMIN_PASSWORD) {
                        modal.classList.add('hidden');
                        resolve(password);
                    } else {
                        errorDiv.textContent = "Incorrect password.";
                        errorDiv.classList.remove('opacity-0');
                    }
                };

                submitBtn.onclick = handler;
                input.onkeyup = (e) => { if (e.key === 'Enter') handler(); };
                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    resolve(null);
                };
            });
        }
        
        function handleForceLogout(targetUserId) {
            if (targetUserId === currentUserId) {
                showMessageBox("Cannot force logout yourself.", true);
                return;
            }
            
            const timeoutDuration = 25; // seconds
            let timeRemaining = timeoutDuration;
            const timerDiv = document.getElementById('force-logout-timer');
            const timerText = document.getElementById('force-logout-text');
            
            timerText.textContent = `User ${targetUserId} has been timed out by an admin. You must wait ${timeRemaining} seconds before logging in.`;
            timerDiv.classList.remove('hidden');
            document.getElementById('code-screen').classList.remove('hidden');
            document.getElementById('code-screen').style.opacity = '0';
            
            const interval = setInterval(() => {
                timeRemaining--;
                timerText.textContent = `User ${targetUserId} has been timed out by an admin. You must wait ${timeRemaining} seconds before logging in.`;

                if (timeRemaining <= 0) {
                    clearInterval(interval);
                    timerDiv.classList.add('hidden');
                    document.getElementById('code-screen').style.opacity = '1';
                }
            }, 1000);
            
            signOut(auth);
            
            showMessageBox(`User ${targetUserId} has been logged out and timed out for ${timeoutDuration} seconds.`, false);
        }

        // --- Event Listeners and Setup ---

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();

            // --- Code Re-entry/Check Logic ---
            document.getElementById('enter-code-button').addEventListener('click', async () => {
                const codeInput = document.getElementById('access-code-input').value.trim();
                const errorDiv = document.getElementById('code-error');

                if (codeInput.length !== 10 || isNaN(codeInput)) {
                    errorDiv.textContent = "Access Code must be 10 numeric digits.";
                    errorDiv.classList.remove('opacity-0');
                    return;
                }
                
                // On re-entry (after forced logout), we check if the entered code belongs to the current UID
                if (!currentUserId) {
                    // Try to find the user ID associated with the code
                    const codeSnap = await getDoc(doc(db, CODES_COLLECTION_PATH, codeInput));
                    if (codeSnap.exists() && isAuthReady) {
                        // We found a matching code, but we can't directly sign in as them.
                        // For this environment, we rely on the initial token. We can only "re-enable" the UI.
                        errorDiv.textContent = "Login successful. UI re-enabled.";
                        errorDiv.classList.remove('opacity-0');
                        handleSuccessfulAuth(); // Re-show UI
                    } else {
                        errorDiv.textContent = "Invalid Code or Authentication Still Loading.";
                        errorDiv.classList.remove('opacity-0');
                    }
                } else {
                    // If we're already logged in (shouldn't happen, but just in case), proceed.
                     handleSuccessfulAuth();
                }
            });
            
            // Allow Enter to submit on the code screen
            document.getElementById('access-code-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('enter-code-button').click();
                }
            });

            // --- Message Input and Sending (Omitted for brevity) ---
            
            document.getElementById('send-button').addEventListener('click', () => {
                const input = document.getElementById('message-input');
                const text = input.value.trim();
                const isFileAttached = document.getElementById('file-status-and-progress').dataset.imageUrl;

                if (text === '' && !isFileAttached) return;

                sendMessage(text, isFileAttached);
            });

            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('send-button').click();
                }
            });

            // --- PFP Upload/Link Handling in Settings (Omitted for brevity) ---
            
            document.getElementById('pfp-url-input').addEventListener('input', (e) => {
                const url = e.target.value.trim();
                document.getElementById('pfp-preview-img').src = url || 'https://placehold.co/100x100/374151/9ca3af?text=U';
            });
            
            document.getElementById('pfp-url-input').addEventListener('change', (e) => {
                currentUserData.pfpUrl = e.target.value.trim();
            });

            // --- Settings Modal Logic ---

            document.getElementById('settings-button').addEventListener('click', () => {
                if (!currentUserData) return;
                
                document.getElementById('username-input').value = currentUserData.username || '';
                document.getElementById('tag-input').value = currentUserData.tag || '';
                document.getElementById('access-code-edit-input').value = currentUserData.accessCode || ''; // Load the code
                document.getElementById('pfp-url-input').value = currentUserData.pfpUrl || '';
                document.getElementById('pfp-preview-img').src = currentUserData.pfpUrl || 'https://placehold.co/100x100/374151/9ca3af?text=U';
                document.getElementById('about-me-input').value = currentUserData.aboutMe || '';
                
                document.getElementById('settings-modal-bg').classList.remove('hidden');
            });
            
            document.getElementById('save-settings-button').addEventListener('click', saveUserProfile);
            document.getElementById('close-settings-button').addEventListener('click', () => {
                document.getElementById('settings-modal-bg').classList.add('hidden');
            });

            // --- Enter Key to Save Settings ---
            const settingsInputs = document.querySelectorAll('#settings-modal-bg input, #settings-modal-bg textarea');
            settingsInputs.forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && input.tagName !== 'TEXTAREA') { // Don't save if Enter is pressed in About Me textarea
                        e.preventDefault();
                        saveUserProfile();
                    }
                });
            });


            // --- Message Interaction (Edit/Delete/Profile Click) (Omitted for brevity) ---
            
            document.getElementById('messages-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('message-pfp') || e.target.classList.contains('message-username')) {
                    const userId = e.target.dataset.userId;
                    displayMembersList(userId);
                    return;
                }
                
                if (e.target.closest('.delete-message-btn')) {
                    const btn = e.target.closest('.delete-message-btn');
                    const messageId = btn.dataset.messageId;
                    const messageRow = btn.closest('.message-row');
                    const messageUserId = messageRow.dataset.userId;

                    const deleteAction = async () => {
                        if (messageUserId === currentUserId) {
                            deleteMessage(messageId);
                        } else if (isAdmin) {
                            const password = await promptAdminPassword();
                            if (password === ADMIN_PASSWORD) {
                                deleteMessage(messageId);
                            } else if (password !== null) {
                                showMessageBox("Incorrect admin password for deletion.", true);
                            }
                        }
                    };
                    
                    showMessageBox("Are you sure you want to delete this message?", false, deleteAction, true);
                    return;
                }

                if (e.target.closest('.edit-message-btn')) {
                    const btn = e.target.closest('.edit-message-btn');
                    const messageRow = btn.closest('.message-row');
                    const messageContentDiv = messageRow.querySelector('.message-content-text');
                    const editInput = messageRow.querySelector('.edit-input');
                    const editActions = messageRow.querySelector('.edit-actions');
                    const messageUserId = messageRow.dataset.userId;
                    
                    if (messageUserId === currentUserId || isAdmin) {
                        messageContentDiv.classList.add('hidden');
                        editActions.classList.remove('hidden');
                        editInput.classList.remove('hidden');
                        editInput.focus();
                    }
                    return;
                }
                
                if (e.target.closest('.save-edit-btn')) {
                    const btn = e.target.closest('.save-edit-btn');
                    const messageRow = btn.closest('.message-row');
                    const messageId = messageRow.dataset.messageId;
                    const editInput = messageRow.querySelector('.edit-input');
                    const newContent = editInput.value.trim();
                    const messageUserId = messageRow.dataset.userId;

                    const finalizeEdit = () => {
                        if (newContent) {
                            editMessage(messageId, newContent);
                        }
                        messageRow.querySelector('.message-content-text').classList.remove('hidden');
                        messageRow.querySelector('.edit-actions').classList.add('hidden');
                        editInput.classList.add('hidden');
                    };
                    
                    if (messageUserId !== currentUserId && isAdmin) {
                        promptAdminPassword().then(password => {
                            if (password === ADMIN_PASSWORD) {
                                finalizeEdit();
                            } else if (password !== null) {
                                showMessageBox("Incorrect admin password for editing.", true);
                                editInput.classList.remove('hidden');
                                messageRow.querySelector('.edit-actions').classList.remove('hidden');
                            }
                        });
                    } else {
                        finalizeEdit();
                    }
                    return;
                }
                
                if (e.target.closest('.cancel-edit-btn')) {
                    const btn = e.target.closest('.cancel-edit-btn');
                    const messageRow = btn.closest('.message-row');
                    messageRow.querySelector('.message-content-text').classList.remove('hidden');
                    messageRow.querySelector('.edit-input').classList.add('hidden');
                    messageRow.querySelector('.edit-actions').classList.add('hidden');
                    return;
                }
            });

            // --- Admin Controls in Member List (Omitted for brevity) ---
            
            document.getElementById('admin-controls').addEventListener('click', async (e) => {
                const btn = e.target.closest('.admin-action-btn');
                if (!btn) return;

                const action = btn.dataset.action;
                const targetUserId = document.getElementById('admin-controls').dataset.targetId;

                if (!targetUserId) {
                    showMessageBox("No target user selected.", true);
                    return;
                }

                if (action === 'timeout') {
                    showMessageBox(`Timeout user ${targetUserId} for 10 minutes?`, false, () => attemptAdminAction(action, targetUserId, '10'), true);
                } else if (action === 'warn') {
                    showMessageBox(`Warn user ${targetUserId}?`, false, () => attemptAdminAction(action, targetUserId), true);
                } else if (action === 'ban') {
                    showMessageBox(`Ban Server (Global Chat) is not implemented yet.`, false, null, false);
                }
            });
            
            document.body.addEventListener('click', async (e) => {
                if (e.target.closest('#admin-context-menu button[data-action="force-logout"]')) {
                    const targetId = e.target.dataset.userId;
                    if (targetId) {
                        attemptAdminAction('force-logout', targetId);
                    }
                }
            });


            // --- Utility UI Functions (Omitted for brevity) ---

            function scrollToBottom() {
                const container = document.getElementById('messages-container');
                container.scrollTop = container.scrollHeight;
            }
            
            function clearFileAttachment() {
                document.getElementById('file-status-and-progress').classList.add('hidden');
                document.getElementById('file-status-and-progress').dataset.imageUrl = '';
                document.getElementById('file-name-display').textContent = '';
                document.getElementById('file-input').value = '';
            }

        }); // DOMContentLoaded end
        
        // --- Global Message/Modal Box (Omitted for brevity) ---
        
        let messageBoxTimeout;
        function showMessageBox(message, isError = false, onConfirm = null, requiresConfirm = false) {
            clearTimeout(messageBoxTimeout);
            const box = document.getElementById('message-box');
            const text = document.getElementById('message-box-text');
            const confirmBtn = document.getElementById('message-box-confirm');

            text.innerHTML = message;
            box.classList.remove('bg-green-700', 'bg-red-700');
            box.classList.add(isError ? 'bg-red-700' : 'bg-green-700');
            box.classList.remove('hidden');

            if (requiresConfirm && onConfirm) {
                confirmBtn.classList.remove('hidden');
                confirmBtn.onclick = () => {
                    box.classList.add('hidden');
                    onConfirm();
                };
            } else {
                confirmBtn.classList.add('hidden');
                confirmBtn.onclick = null;
                
                messageBoxTimeout = setTimeout(() => {
                    box.classList.add('hidden');
                }, 3000);
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        .full-screen-app {
            width: 100vw;
            height: 100vh;
            max-width: none;
            max-height: none;
            display: flex;
        }

        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
            padding-right: 8px;
        }
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 4px;
        }
        .chat-container::-webkit-scrollbar-track {
            background-color: #1f2937;
        }

        /* Message hover menu styling */
        .message-row:hover .message-actions {
            opacity: 1;
            transform: translateX(0);
        }
        .message-actions {
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            transform: translateX(-5px);
            background-color: #1f2937; /* Gray-800 */
        }
        
        .member-list-item:hover {
            background-color: #374151; /* Gray-700 */
        }
    </style>

    <!-- Main Content Area -->
    <div class="w-full max-w-7xl h-[90vh] bg-gray-800 rounded-xl shadow-2xl overflow-hidden flex" id="main-app-container">
        
        <!-- Access Code Screen (Initial State) -->
        <div id="code-screen" class="absolute inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center p-8 transition-opacity duration-500">
            <h2 class="text-3xl font-bold mb-4 text-center text-indigo-400">Welcome to School Chat</h2>
            <p class="text-gray-400 mb-6 text-center">Enter your 10-digit Access Code to re-enable chat.</p>
            <input type="text" id="access-code-input" maxlength="10" placeholder="0000000000" class="w-full max-w-sm p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 text-center text-xl tracking-wider focus:ring-indigo-500 focus:border-indigo-500 mb-4 uppercase">
            <button id="enter-code-button" class="w-full max-w-sm p-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-semibold transition duration-150">ENTER</button>
            <p id="code-error" class="mt-4 text-sm font-medium text-red-400 opacity-0 transition duration-500"></p>
            <p id="loading-status" class="mt-6 text-gray-500 text-sm">Initializing chat service...</p>
        </div>
        
        <!-- Forced Logout/Timeout Screen -->
        <div id="force-logout-timer" class="absolute inset-0 z-50 bg-gray-900 hidden flex-col items-center justify-center p-8 transition-opacity duration-500">
            <svg class="w-20 h-20 text-red-500 mb-4 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            <h2 class="text-4xl font-extrabold mb-4 text-center text-red-400">TIMED OUT</h2>
            <p id="force-logout-text" class="text-xl text-gray-300 text-center"></p>
        </div>


        <!-- Left Sidebar (Servers) -->
        <div id="sidebar" class="w-20 bg-gray-900 flex flex-col items-center py-3 space-y-3 hidden">
            <!-- Global Chat -->
            <div id="global-server-icon" class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-xl font-bold hover:rounded-xl transition-all duration-200 cursor-pointer shadow-lg active-server" data-server-id="global">SC</div>
        </div>
        
        <!-- Chat Panel (Main View) -->
        <div id="chat-panel" class="flex-grow flex flex-col hidden opacity-0 transition-opacity duration-500">
            
            <!-- Header (Channel Name) -->
            <header class="bg-gray-700 p-4 border-b border-gray-600 shadow-lg flex justify-between items-center">
                <h1 class="text-xl font-bold text-indigo-400" id="current-channel-title"># Global Chat</h1>
            </header>
            
            <!-- Messages Container -->
            <div id="messages-container" class="chat-container flex flex-col space-y-4 p-4 flex-grow">
                <!-- Messages will be injected here by JavaScript -->
            </div>

            <!-- Message Input Area -->
            <div class="p-4 border-t border-gray-700 bg-gray-700 relative">
                <div id="file-status-and-progress" class="mb-2 hidden" data-image-url="">
                    <div id="file-name-display" class="text-sm text-gray-300 font-medium truncate mb-1">Image Link Attached</div>
                </div>

                <div class="flex items-end space-x-2">
                    <!-- Message Textarea -->
                    <textarea id="message-input" rows="1" class="flex-grow resize-none p-3 rounded-xl bg-gray-800 border border-gray-600 text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 focus:outline-none transition duration-150" placeholder="Message #global-chat..."></textarea>
                    
                    <!-- Send Button -->
                    <button id="send-button" class="p-3 bg-indigo-600 hover:bg-indigo-700 rounded-full text-white font-semibold transition duration-150 shadow-md flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7" /></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Right Sidebar (Members List / Profile Viewer) -->
        <div id="members-panel" class="w-80 bg-gray-700 flex flex-col p-4 shadow-inner hidden">
            <h2 class="text-xl font-bold text-gray-200 border-b border-gray-600 pb-2 mb-4">Profile Viewer</h2>
            
            <div id="profile-view-details" class="flex flex-col items-center p-4 bg-gray-800 rounded-xl mb-4 relative" data-target-id="">
                <img id="view-pfp" class="w-24 h-24 rounded-full object-cover border-4 border-indigo-400" src="https://placehold.co/96x96/1f2937/9ca3af?text=U" alt="Profile Picture">
                <p id="view-display-name" class="text-2xl font-bold mt-3 text-white"></p>
                <p id="view-access-code" class="text-sm font-mono text-gray-400"></p>
                <h3 class="text-sm font-semibold text-gray-300 mt-4 mb-1 self-start">About Me:</h3>
                <textarea id="view-about-me" class="w-full text-sm text-gray-300 bg-gray-700 p-2 rounded-lg resize-none h-20" readonly>This user has not set an 'About Me' yet.</textarea>
                
                <p class="text-xs text-indigo-400 mt-2 text-center">Right-click profile for Admin options.</p>
            </div>

            <!-- Admin Controls (Only visible to Admin) - for quick common actions -->
            <div id="admin-controls" class="space-y-2 pt-4 border-t border-gray-600 hidden" data-target-id="">
                <h3 class="text-lg font-semibold text-red-400">Admin Quick Actions</h3>
                <button data-action="timeout" class="admin-action-btn w-full p-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg text-sm font-semibold transition duration-150 shadow-md">Timeout User (10m)</button>
                <button data-action="warn" class="admin-action-btn w-full p-2 bg-orange-600 hover:bg-orange-700 rounded-lg text-sm font-semibold transition duration-150 shadow-md">Warn User</button>
                <button data-action="ban" class="admin-action-btn w-full p-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-semibold transition duration-150 shadow-md">Ban Server (Placeholder)</button>
            </div>
            
        </div>

        <!-- Settings/User Info Bar (Bottom Right) -->
        <div id="user-info-bar" class="absolute bottom-0 right-0 m-4 hidden z-10">
             <button id="settings-button" class="flex items-center space-x-2 p-2 bg-gray-700 rounded-full shadow-xl hover:bg-gray-600 transition duration-150">
                <img id="pfp-thumbnail" class="w-8 h-8 rounded-full border-2 border-indigo-400 object-cover" src="https://placehold.co/32x32/1f2937/9ca3af?text=U" alt="Profile Picture">
                <span id="user-name-display" class="text-sm font-semibold pr-1">Settings</span>
            </button>
        </div>

    </div>

    <!-- Admin Password Modal -->
    <div id="admin-password-modal-bg" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-[100]">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold text-red-400 mb-4">Admin Confirmation</h3>
            <p class="text-gray-300 mb-3">Enter the admin password to continue.</p>
            <input type="password" id="admin-password-input" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 focus:ring-red-500 focus:border-red-500 mb-3" placeholder="Admin Password">
            <p id="admin-password-error" class="text-sm text-red-400 opacity-0 mb-3 transition duration-300"></p>
            <div class="flex justify-end space-x-3">
                <button id="admin-password-cancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-white transition">Cancel</button>
                <button id="admin-password-submit" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-white font-semibold transition">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal-bg" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-xl w-full max-w-lg shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-3xl font-bold text-indigo-400">User Settings</h3>
                <button id="close-settings-button" class="text-gray-400 hover:text-white transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div class="mb-6 flex flex-col items-center">
                <img id="pfp-preview-img" class="w-28 h-28 object-cover rounded-full border-4 border-indigo-500 shadow-xl" src="https://placehold.co/100x100/374151/9ca3af?text=U" alt="Profile Picture Preview">
                <p class="text-sm text-gray-400 mt-2">Preview</p>
            </div>

            <div class="space-y-4">
                
                <label class="block">
                    <span class="text-gray-300 font-medium block mb-1">Access Code (10 digits)</span>
                    <input type="text" id="access-code-edit-input" maxlength="10" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Your 10-digit code">
                    <p class="text-xs text-gray-500 mt-1">You must use this code to re-enable chat if you are timed out.</p>
                </label>

                <label class="block">
                    <span class="text-gray-300 font-medium block mb-1">Username (e.g., Garrett)</span>
                    <input type="text" id="username-input" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Your Username">
                </label>
                
                <label class="block">
                    <span class="text-gray-300 font-medium block mb-1">Tag (4-digit number, e.g., 4849)</span>
                    <input type="text" id="tag-input" maxlength="4" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Your Tag">
                </label>

                <label class="block">
                    <span class="text-gray-300 font-medium block mb-1">Profile Picture URL Link</span>
                    <input type="url" id="pfp-url-input" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Paste image URL here">
                </label>
                
                <label class="block">
                    <span class="text-gray-300 font-medium block mb-1">About Me</span>
                    <textarea id="about-me-input" class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 focus:ring-indigo-500 focus:border-indigo-500 resize-none h-24" placeholder="Tell everyone a little bit about yourself..."></textarea>
                </label>
            </div>
            
            <button id="save-settings-button" class="mt-6 w-full p-3 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-semibold transition duration-150 shadow-md">
                Save Profile
            </button>
        </div>
    </div>
    
    <!-- Floating Message Box (Alert/Confirmation) -->
    <div id="message-box" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 p-4 rounded-xl shadow-2xl text-white font-semibold flex items-center space-x-4 hidden z-[1000]">
        <span id="message-box-text"></span>
        <button id="message-box-confirm" class="px-3 py-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full text-sm font-bold hidden transition duration-150">Confirm</button>
    </div>

</div>